<html><head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Android 9.0源码学习-AccessibilityManager</title>
  <link href="images/style.css" rel="stylesheet">
</head>

<body class="stackedit"><div class="stackedit__html">

<section class="ouvJEz"><h1 class="_1RuRku">Android 9.0源码学习-AccessibilityManager</h1><div class="rEsl9f"><div class="_2mYfmT"><a class="_1OhGeD" href="/u/aced53dd9020" target="_blank" rel="noopener noreferrer"><img class="_13D2Eh" alt="" src="images/android05701.jpg"></a><div style="margin-left: 8px;"><div class="_3U4Smb"><span class="FxYr8x"><a class="_1OhGeD" href="/u/aced53dd9020" target="_blank" rel="noopener noreferrer">Dufre</a></span><button class="_3kba3h _1OyPqC _3Mi9q9 _34692-" type="button" data-locale="zh-CN"><span>关注</span></button></div><div class="s-dsoj"><span class="_3tCVn5"><i class="anticon" aria-label="ic-diamond"><svg xmlns="http://www.w3.org/2000/svg" class="" aria-hidden="true" fill="currentColor" focusable="false" width="1em" height="1em"><use xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="#ic-diamond" /></svg></i><span>0.974</span></span><time datetime="2018-11-04T07:50:07.000Z">2018.11.04 15:50:07</time><span>字数 2,131</span><span>阅读 2,916</span></div></div></div></div><article class="_2rhmJa"><p>Android Accessibility是为了帮助残障人士更好使用手机开发出来一个模块，比如屏幕阅读器，手势等等，当然现在已经被玩坏了，各种外挂，比如微信抢红包的外挂，也是基于Accessibility写出来的。</p>
<p>Android developer有关于<a href="https://developer.android.com/guide/topics/ui/accessibility/" target="_blank" rel="nofollow">Accessibility</a>的介绍（需要科学上网），我自己也基于这个有一篇笔记<a href="https://blog.csdn.net/u011391629/article/details/82978530" target="_blank" rel="nofollow">Android-Accessibility（Android 8.0以上）</a>。</p>
<h1>Accessibility Architecture</h1>
<p>先拿一个具体的例子来看，这是一个抢红包的外挂，把WeChat称作<strong>Target APP</strong>，就是被监控的APP，当跳出来一个红包，触发了一个<strong>AccessibilityEvent</strong>，system_server中的<strong>AccessibilityManagerService</strong>将AccessibilityEvent分发给有<strong>AccessibilityService</strong>的APP，称为<strong>Accessibility APP</strong>，这个AccessibilityService受到这个AccessibilityEvent后，会找到这个页面的Open Button，模拟点击。（Target APP和Accessibility APP是我看别的博客这么取的）<br>
</p><div class="image-package">
<div class="image-container" style="max-height: 475px; max-width: 700px; background-color: transparent;">
<div class="image-container-fill" style="padding-bottom: 61.12%;"></div>
<div class="image-view" data-height="475" data-width="777"><img src="images/android05702.jpg" data-image-index="0" data-original-filesize="78288" data-original-format="image/png" data-original-height="475" data-original-width="777" data-original-src="//upload-images.jianshu.io/upload_images/4465577-7939a3a6fa15a3fa"></div>
</div>
<div class="image-caption">在这里插入图片描述</div>
</div><p></p>
<h2>Core Class</h2>
<p>刚才举得例子是表象，那么程序内部，这个过程其实就是三个类之间的交互，当然实际不止这么简单啦，这个后面再讲，现在只要记住这三个是核心的类就好了。（<strong>以下都会用缩写代替</strong>）</p>
<ul>
<li>AccessibilityManager（<strong>AM</strong>）：Send AccessibilityEvent</li>
<li>AccessibilityServiceManager（<strong>AMS</strong>）：Dispatch</li>
<li>AccessibilityService（<strong>AS</strong>）：Response</li>
</ul>
<div class="image-package">
<div class="image-container" style="max-height: 261px; max-width: 700px; background-color: transparent;">
<div class="image-container-fill" style="padding-bottom: 33.16%;"></div>
<div class="image-view" data-height="261" data-width="787"><img src="images/android05703.jpg" data-image-index="1" data-original-filesize="24638" data-original-format="image/png" data-original-height="261" data-original-width="787" data-original-src="//upload-images.jianshu.io/upload_images/4465577-b4b503aeb7e57b26"></div>
</div>
<div class="image-caption">在这里插入图片描述</div>
</div>
<h2>File List</h2>
<table>
<thead>
<tr>
<th style="text-align: left;">File Name</th>
<th style="text-align: left;">File Path</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>View.java</strong></td>
<td style="text-align: left;">/frameworks/base/core/java/android/view/View.java</td>
</tr>
<tr>
<td style="text-align: left;"><strong>ViewRootImpl.java</strong></td>
<td style="text-align: left;">/frameworks/base/core/java/android/view/ViewRootImpl.java</td>
</tr>
<tr>
<td style="text-align: left;"><strong>AccessibilityManager.java</strong></td>
<td style="text-align: left;">/frameworks/base/core/java/android/view/accessibility/AccessibilityManager.java</td>
</tr>
<tr>
<td style="text-align: left;"><strong>AccessibilityManagerService.java</strong></td>
<td style="text-align: left;">/frameworks/base/services/accessibility/java/com/android/server/accessibility/AccessibilityManagerService.java</td>
</tr>
<tr>
<td style="text-align: left;"><strong>AbstractAccessibilityServiceConnection.java</strong></td>
<td style="text-align: left;">/frameworks/base/services/accessibility/java/com/android/server/accessibility/AbstractAccessibilityServiceConnection.java</td>
</tr>
<tr>
<td style="text-align: left;"><strong>AccessibilityServiceConnection.java</strong></td>
<td style="text-align: left;">/frameworks/base/services/accessibility/java/com/android/server/accessibility/AccessibilityServiceConnection.java</td>
</tr>
<tr>
<td style="text-align: left;"><strong>AccessibilityManagerService.java</strong></td>
<td style="text-align: left;">/frameworks/base/services/accessibility/java/com/android/server/accessibility/AccessibilityManagerService.java</td>
</tr>
<tr>
<td style="text-align: left;"><strong>AccessibilityService.java</strong></td>
<td style="text-align: left;">/frameworks/base/core/java/android/accessibilityservice/AccessibilityService.java</td>
</tr>
</tbody>
</table>
<h1>Accessibility Flow</h1>
<p>Accessibility Flow主要有下面几个Flow了：</p>
<ol>
<li>AMS绑定AS</li>
<li>AM与AMS联系</li>
<li>AccessibilityEvent Dispatch</li>
<li>
<p>Response to  AccessibilityEvent</p>
<br>
<div class="image-package">
<div class="image-container" style="max-height: 234px; max-width: 700px; background-color: transparent;">
<div class="image-container-fill" style="padding-bottom: 30.86%;"></div>
<div class="image-view" data-height="234" data-width="758"><img src="images/android05704.jpg" data-image-index="2" data-original-filesize="21167" data-original-format="image/png" data-original-height="234" data-original-width="758" data-original-src="//upload-images.jianshu.io/upload_images/4465577-653521530b594976"></div>
</div>
<div class="image-caption">在这里插入图片描述</div>
</div>
</li>
</ol>
<h2>AMS绑定AS</h2>
<div class="image-package">
<div class="image-container" style="max-height: 531px; max-width: 700px; background-color: transparent;">
<div class="image-container-fill" style="padding-bottom: 55.72%;"></div>
<div class="image-view" data-height="531" data-width="953"><img src="images/android05705.jpg" data-image-index="3" data-original-filesize="68027" data-original-format="image/png" data-original-height="531" data-original-width="953" data-original-src="//upload-images.jianshu.io/upload_images/4465577-28294969c864abcc"></div>
</div>
<div class="image-caption">在这里插入图片描述</div>
</div>
<p>上图是AMS与AS联系的flow，下面一步一步的来说。</p>
<p><strong>Step1：什么时候AMS会绑定AS？</strong></p>
<ul>
<li>Settings-&gt;Accessibility-&gt;enable（<code>enableAccessibilityServiceLocked()</code>）</li>
<li>Settings-&gt;Accessibility-&gt;disable（<code>disableAccessibilityServiceLocked()</code>）</li>
<li>Some RegisterBroadcastReceivers （<code>registerBroadcastReceivers()</code>）
<ul>
<li><code>onSomePackagesChanged()</code></li>
<li><code>onPackageUpdateFinished()</code></li>
<li><code>onHandleForceStop()</code></li>
<li><code>onPackageRemoved()</code></li>
</ul>
</li>
<li>Others State Change</li>
</ul>
<p>当用户在设置-&gt;无障碍里面选择了开启或关闭一个辅助功能，会导致一些系统状态会变化；Accessibility APP的安装状态会以BroadcastReceivers的方式会通知状态改变；还有其他的一些状态改变。这些变化最终会调用到AMS的<code>onUserStateChangedLocked()</code>方法。</p>
<div class="image-package">
<div class="image-container" style="max-height: 425px; max-width: 369px; background-color: transparent;">
<div class="image-container-fill" style="padding-bottom: 115.17%;"></div>
<div class="image-view" data-height="425" data-width="369"><img src="images/android05706.jpg" data-image-index="4" data-original-filesize="57361" data-original-format="image/png" data-original-height="425" data-original-width="369" data-original-src="//upload-images.jianshu.io/upload_images/4465577-8800a54a18e22654"></div>
</div>
<div class="image-caption">在这里插入图片描述</div>
</div>
<p><em>AccessibilityManagerService.java -- <code>enableAccessibilityServiceLocked()</code></em></p>
<div class="_2Uzcx_"><button class="VJbwyy" aria-label="复制代码" type="button"><i class="anticon anticon-copy" aria-label="icon: copy"><svg xmlns="http://www.w3.org/2000/svg" class="" aria-hidden="true" fill="currentColor" viewBox="64 64 896 896" focusable="false" width="1em" height="1em" data-icon="copy"><path d="M 832 64 H 296 c -4.4 0 -8 3.6 -8 8 v 56 c 0 4.4 3.6 8 8 8 h 496 v 688 c 0 4.4 3.6 8 8 8 h 56 c 4.4 0 8 -3.6 8 -8 V 96 c 0 -17.7 -14.3 -32 -32 -32 Z M 704 192 H 192 c -17.7 0 -32 14.3 -32 32 v 530.7 c 0 8.5 3.4 16.6 9.4 22.6 l 173.3 173.3 c 2.2 2.2 4.7 4 7.4 5.5 v 1.9 h 4.2 c 3.5 1.3 7.2 2 11 2 H 704 c 17.7 0 32 -14.3 32 -32 V 224 c 0 -17.7 -14.3 -32 -32 -32 Z M 350 856.2 L 263.9 770 H 350 v 86.2 Z M 664 888 H 414 V 746 c 0 -22.1 -17.9 -40 -40 -40 H 232 V 264 h 432 v 624 Z" /></svg></i></button><pre class="line-numbers  language-java"><code class="java  language-java">          <span class="token comment">/**
2333       * Enables accessibility service specified by {@param componentName} for the {@param userId}.
2334       */</span>
<span class="token number">2335</span>      <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">enableAccessibilityServiceLocked</span><span class="token punctuation">(</span><span class="token class-name">ComponentName</span> componentName<span class="token punctuation">,</span> <span class="token keyword">int</span> userId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">2336</span>          <span class="token keyword">final</span> <span class="token class-name">SettingStringHelper</span> setting <span class="token operator">=</span>
<span class="token number">2337</span>                  <span class="token keyword">new</span> <span class="token class-name">SettingStringHelper</span><span class="token punctuation">(</span>
<span class="token number">2338</span>                          mContext<span class="token punctuation">.</span><span class="token function">getContentResolver</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token number">2339</span>                          <span class="token class-name">Settings</span><span class="token punctuation">.</span><span class="token class-name">Secure</span><span class="token punctuation">.</span>ENABLED_ACCESSIBILITY_SERVICES<span class="token punctuation">,</span>
<span class="token number">2340</span>                          userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">2341</span>          setting<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token class-name">ComponentNameSet</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>setting<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> componentName<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">2342</span>  
<span class="token number">2343</span>          <span class="token class-name">UserState</span> userState <span class="token operator">=</span> <span class="token function">getUserStateLocked</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">2344</span>          <span class="token keyword">if</span> <span class="token punctuation">(</span>userState<span class="token punctuation">.</span>mEnabledServices<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>componentName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">2345</span>              <span class="token function">onUserStateChangedLocked</span><span class="token punctuation">(</span>userState<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">2346</span>          <span class="token punctuation">}</span>
<span class="token number">2347</span>      <span class="token punctuation">}</span>
<span class="line-numbers-rows" aria-hidden="true"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div>
<p><em>AccessibilityManagerService.java -- <code>disableAccessibilityServiceLocked()</code></em></p>
<div class="_2Uzcx_"><button class="VJbwyy" aria-label="复制代码" type="button"><i class="anticon anticon-copy" aria-label="icon: copy"><svg xmlns="http://www.w3.org/2000/svg" class="" aria-hidden="true" fill="currentColor" viewBox="64 64 896 896" focusable="false" width="1em" height="1em" data-icon="copy"><path d="M 832 64 H 296 c -4.4 0 -8 3.6 -8 8 v 56 c 0 4.4 3.6 8 8 8 h 496 v 688 c 0 4.4 3.6 8 8 8 h 56 c 4.4 0 8 -3.6 8 -8 V 96 c 0 -17.7 -14.3 -32 -32 -32 Z M 704 192 H 192 c -17.7 0 -32 14.3 -32 32 v 530.7 c 0 8.5 3.4 16.6 9.4 22.6 l 173.3 173.3 c 2.2 2.2 4.7 4 7.4 5.5 v 1.9 h 4.2 c 3.5 1.3 7.2 2 11 2 H 704 c 17.7 0 32 -14.3 32 -32 V 224 c 0 -17.7 -14.3 -32 -32 -32 Z M 350 856.2 L 263.9 770 H 350 v 86.2 Z M 664 888 H 414 V 746 c 0 -22.1 -17.9 -40 -40 -40 H 232 V 264 h 432 v 624 Z" /></svg></i></button><pre class="line-numbers  language-java"><code class="java  language-java">         <span class="token comment">/**
2350       * Disables accessibility service specified by {@param componentName} for the {@param userId}.
2351       */</span>
<span class="token number">2352</span>      <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">disableAccessibilityServiceLocked</span><span class="token punctuation">(</span><span class="token class-name">ComponentName</span> componentName<span class="token punctuation">,</span> <span class="token keyword">int</span> userId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">2353</span>          <span class="token keyword">final</span> <span class="token class-name">SettingsStringUtil</span><span class="token punctuation">.</span><span class="token class-name">SettingStringHelper</span> setting <span class="token operator">=</span>
<span class="token number">2354</span>                  <span class="token keyword">new</span> <span class="token class-name">SettingStringHelper</span><span class="token punctuation">(</span>
<span class="token number">2355</span>                          mContext<span class="token punctuation">.</span><span class="token function">getContentResolver</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token number">2356</span>                          <span class="token class-name">Settings</span><span class="token punctuation">.</span><span class="token class-name">Secure</span><span class="token punctuation">.</span>ENABLED_ACCESSIBILITY_SERVICES<span class="token punctuation">,</span>
<span class="token number">2357</span>                          userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">2358</span>          setting<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token class-name">ComponentNameSet</span><span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>setting<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> componentName<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">2359</span>  
<span class="token number">2360</span>          <span class="token class-name">UserState</span> userState <span class="token operator">=</span> <span class="token function">getUserStateLocked</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">2361</span>          <span class="token keyword">if</span> <span class="token punctuation">(</span>userState<span class="token punctuation">.</span>mEnabledServices<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>componentName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">2362</span>              <span class="token function">onUserStateChangedLocked</span><span class="token punctuation">(</span>userState<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">2363</span>          <span class="token punctuation">}</span>
<span class="token number">2364</span>      <span class="token punctuation">}</span>
<span class="line-numbers-rows" aria-hidden="true"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div>
<p><em>AccessibilityManagerService.java -- <code>registerBroadcastReceivers()</code></em></p>
<div class="_2Uzcx_"><button class="VJbwyy" aria-label="复制代码" type="button"><i class="anticon anticon-copy" aria-label="icon: copy"><svg xmlns="http://www.w3.org/2000/svg" class="" aria-hidden="true" fill="currentColor" viewBox="64 64 896 896" focusable="false" width="1em" height="1em" data-icon="copy"><path d="M 832 64 H 296 c -4.4 0 -8 3.6 -8 8 v 56 c 0 4.4 3.6 8 8 8 h 496 v 688 c 0 4.4 3.6 8 8 8 h 56 c 4.4 0 8 -3.6 8 -8 V 96 c 0 -17.7 -14.3 -32 -32 -32 Z M 704 192 H 192 c -17.7 0 -32 14.3 -32 32 v 530.7 c 0 8.5 3.4 16.6 9.4 22.6 l 173.3 173.3 c 2.2 2.2 4.7 4 7.4 5.5 v 1.9 h 4.2 c 3.5 1.3 7.2 2 11 2 H 704 c 17.7 0 32 -14.3 32 -32 V 224 c 0 -17.7 -14.3 -32 -32 -32 Z M 350 856.2 L 263.9 770 H 350 v 86.2 Z M 664 888 H 414 V 746 c 0 -22.1 -17.9 -40 -40 -40 H 232 V 264 h 432 v 624 Z" /></svg></i></button><pre class="line-numbers  language-java"><code class="java  language-java">    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">registerBroadcastReceivers</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">324</span>          <span class="token class-name">PackageMonitor</span> monitor <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PackageMonitor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">325</span>              <span class="token annotation punctuation">@Override</span>
<span class="token number">326</span>              <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onSomePackagesChanged</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">327</span>                  <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>mLock<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">328</span>                      <span class="token comment">// Only the profile parent can install accessibility services.</span>
<span class="token number">329</span>                      <span class="token comment">// Therefore we ignore packages from linked profiles.</span>
<span class="token number">330</span>                      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">getChangingUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> mCurrentUserId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">331</span>                          <span class="token keyword">return</span><span class="token punctuation">;</span>
<span class="token number">332</span>                      <span class="token punctuation">}</span>
<span class="token number">333</span>                      <span class="token comment">// We will update when the automation service dies.</span>
<span class="token number">334</span>                      <span class="token class-name">UserState</span> userState <span class="token operator">=</span> <span class="token function">getCurrentUserStateLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">335</span>                      <span class="token comment">// We have to reload the installed services since some services may</span>
<span class="token number">336</span>                      <span class="token comment">// have different attributes, resolve info (does not support equals),</span>
<span class="token number">337</span>                      <span class="token comment">// etc. Remove them then to force reload.</span>
<span class="token number">338</span>                      userState<span class="token punctuation">.</span>mInstalledServices<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">339</span>                      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">readConfigurationForUserStateLocked</span><span class="token punctuation">(</span>userState<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">340</span>                          <span class="token function">onUserStateChangedLocked</span><span class="token punctuation">(</span>userState<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">341</span>                      <span class="token punctuation">}</span>
<span class="token number">342</span>                  <span class="token punctuation">}</span>
<span class="token number">343</span>              <span class="token punctuation">}</span>
<span class="token number">344</span>  
<span class="token number">345</span>              <span class="token annotation punctuation">@Override</span>
<span class="token number">346</span>              <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onPackageUpdateFinished</span><span class="token punctuation">(</span><span class="token class-name">String</span> packageName<span class="token punctuation">,</span> <span class="token keyword">int</span> uid<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">347</span>                  <span class="token comment">// Unbind all services from this package, and then update the user state to</span>
<span class="token number">348</span>                  <span class="token comment">// re-bind new versions of them.</span>
<span class="token number">349</span>                  <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>mLock<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">350</span>                      <span class="token keyword">final</span> <span class="token keyword">int</span> userId <span class="token operator">=</span> <span class="token function">getChangingUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">351</span>                      <span class="token keyword">if</span> <span class="token punctuation">(</span>userId <span class="token operator">!=</span> mCurrentUserId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">352</span>                          <span class="token keyword">return</span><span class="token punctuation">;</span>
<span class="token number">353</span>                      <span class="token punctuation">}</span>
<span class="token number">354</span>                      <span class="token class-name">UserState</span> userState <span class="token operator">=</span> <span class="token function">getUserStateLocked</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">355</span>                      <span class="token keyword">boolean</span> unboundAService <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token number">356</span>                      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> userState<span class="token punctuation">.</span>mBoundServices<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">357</span>                          <span class="token class-name">AccessibilityServiceConnection</span> boundService <span class="token operator">=</span>
<span class="token number">358</span>                                  userState<span class="token punctuation">.</span>mBoundServices<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">359</span>                          <span class="token class-name">String</span> servicePkg <span class="token operator">=</span> boundService<span class="token punctuation">.</span>mComponentName<span class="token punctuation">.</span><span class="token function">getPackageName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">360</span>                          <span class="token keyword">if</span> <span class="token punctuation">(</span>servicePkg<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>packageName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">361</span>                              boundService<span class="token punctuation">.</span><span class="token function">unbindLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">362</span>                              unboundAService <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token number">363</span>                          <span class="token punctuation">}</span>
<span class="token number">364</span>                      <span class="token punctuation">}</span>
<span class="token number">365</span>                      <span class="token keyword">if</span> <span class="token punctuation">(</span>unboundAService<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">366</span>                          <span class="token function">onUserStateChangedLocked</span><span class="token punctuation">(</span>userState<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">367</span>                      <span class="token punctuation">}</span>
<span class="token number">368</span>                  <span class="token punctuation">}</span>
<span class="token number">369</span>              <span class="token punctuation">}</span>
<span class="token number">370</span>  
<span class="token number">371</span>              <span class="token annotation punctuation">@Override</span>
<span class="token number">372</span>              <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onPackageRemoved</span><span class="token punctuation">(</span><span class="token class-name">String</span> packageName<span class="token punctuation">,</span> <span class="token keyword">int</span> uid<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">373</span>                  <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>mLock<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">374</span>                      <span class="token keyword">final</span> <span class="token keyword">int</span> userId <span class="token operator">=</span> <span class="token function">getChangingUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">375</span>                      <span class="token comment">// Only the profile parent can install accessibility services.</span>
<span class="token number">376</span>                      <span class="token comment">// Therefore we ignore packages from linked profiles.</span>
<span class="token number">377</span>                      <span class="token keyword">if</span> <span class="token punctuation">(</span>userId <span class="token operator">!=</span> mCurrentUserId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">378</span>                          <span class="token keyword">return</span><span class="token punctuation">;</span>
<span class="token number">379</span>                      <span class="token punctuation">}</span>
<span class="token number">380</span>                      <span class="token class-name">UserState</span> userState <span class="token operator">=</span> <span class="token function">getUserStateLocked</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">381</span>                      <span class="token class-name">Iterator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ComponentName</span><span class="token punctuation">&gt;</span></span> it <span class="token operator">=</span> userState<span class="token punctuation">.</span>mEnabledServices<span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">382</span>                      <span class="token keyword">while</span> <span class="token punctuation">(</span>it<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">383</span>                          <span class="token class-name">ComponentName</span> comp <span class="token operator">=</span> it<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">384</span>                          <span class="token class-name">String</span> compPkg <span class="token operator">=</span> comp<span class="token punctuation">.</span><span class="token function">getPackageName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">385</span>                          <span class="token keyword">if</span> <span class="token punctuation">(</span>compPkg<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>packageName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">386</span>                              it<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">387</span>                              <span class="token comment">// Update the enabled services setting.</span>
<span class="token number">388</span>                              <span class="token function">persistComponentNamesToSettingLocked</span><span class="token punctuation">(</span>
<span class="token number">389</span>                                      <span class="token class-name">Settings</span><span class="token punctuation">.</span><span class="token class-name">Secure</span><span class="token punctuation">.</span>ENABLED_ACCESSIBILITY_SERVICES<span class="token punctuation">,</span>
<span class="token number">390</span>                                      userState<span class="token punctuation">.</span>mEnabledServices<span class="token punctuation">,</span> userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">391</span>                              <span class="token comment">// Update the touch exploration granted services setting.</span>
<span class="token number">392</span>                              userState<span class="token punctuation">.</span>mTouchExplorationGrantedServices<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>comp<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">393</span>                              <span class="token function">persistComponentNamesToSettingLocked</span><span class="token punctuation">(</span>
<span class="token number">394</span>                                      <span class="token class-name">Settings</span><span class="token punctuation">.</span><span class="token class-name">Secure</span><span class="token punctuation">.</span>
<span class="token number">395</span>                                      TOUCH_EXPLORATION_GRANTED_ACCESSIBILITY_SERVICES<span class="token punctuation">,</span>
<span class="token number">396</span>                                      userState<span class="token punctuation">.</span>mTouchExplorationGrantedServices<span class="token punctuation">,</span> userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">397</span>                              <span class="token function">onUserStateChangedLocked</span><span class="token punctuation">(</span>userState<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">398</span>                              <span class="token keyword">return</span><span class="token punctuation">;</span>
<span class="token number">399</span>                          <span class="token punctuation">}</span>
<span class="token number">400</span>                      <span class="token punctuation">}</span>
<span class="token number">401</span>                  <span class="token punctuation">}</span>
<span class="token number">402</span>              <span class="token punctuation">}</span>
<span class="token number">403</span>  
<span class="token number">404</span>              <span class="token annotation punctuation">@Override</span>
<span class="token number">405</span>              <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">onHandleForceStop</span><span class="token punctuation">(</span><span class="token class-name">Intent</span> intent<span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> packages<span class="token punctuation">,</span>
<span class="token number">406</span>                      <span class="token keyword">int</span> uid<span class="token punctuation">,</span> <span class="token keyword">boolean</span> doit<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">407</span>                  <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>mLock<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">408</span>                      <span class="token keyword">final</span> <span class="token keyword">int</span> userId <span class="token operator">=</span> <span class="token function">getChangingUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">409</span>                      <span class="token comment">// Only the profile parent can install accessibility services.</span>
<span class="token number">410</span>                      <span class="token comment">// Therefore we ignore packages from linked profiles.</span>
<span class="token number">411</span>                      <span class="token keyword">if</span> <span class="token punctuation">(</span>userId <span class="token operator">!=</span> mCurrentUserId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">412</span>                          <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token number">413</span>                      <span class="token punctuation">}</span>
<span class="token number">414</span>                      <span class="token class-name">UserState</span> userState <span class="token operator">=</span> <span class="token function">getUserStateLocked</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">415</span>                      <span class="token class-name">Iterator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ComponentName</span><span class="token punctuation">&gt;</span></span> it <span class="token operator">=</span> userState<span class="token punctuation">.</span>mEnabledServices<span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">416</span>                      <span class="token keyword">while</span> <span class="token punctuation">(</span>it<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">417</span>                          <span class="token class-name">ComponentName</span> comp <span class="token operator">=</span> it<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">418</span>                          <span class="token class-name">String</span> compPkg <span class="token operator">=</span> comp<span class="token punctuation">.</span><span class="token function">getPackageName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">419</span>                          <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> pkg <span class="token operator">:</span> packages<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">420</span>                              <span class="token keyword">if</span> <span class="token punctuation">(</span>compPkg<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>pkg<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">421</span>                                  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>doit<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">422</span>                                      <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token number">423</span>                                  <span class="token punctuation">}</span>
<span class="token number">424</span>                                  it<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">425</span>                                  <span class="token function">persistComponentNamesToSettingLocked</span><span class="token punctuation">(</span>
<span class="token number">426</span>                                          <span class="token class-name">Settings</span><span class="token punctuation">.</span><span class="token class-name">Secure</span><span class="token punctuation">.</span>ENABLED_ACCESSIBILITY_SERVICES<span class="token punctuation">,</span>
<span class="token number">427</span>                                          userState<span class="token punctuation">.</span>mEnabledServices<span class="token punctuation">,</span> userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">428</span>                                  <span class="token function">onUserStateChangedLocked</span><span class="token punctuation">(</span>userState<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">429</span>                              <span class="token punctuation">}</span>
<span class="token number">430</span>                          <span class="token punctuation">}</span>
<span class="token number">431</span>                      <span class="token punctuation">}</span>
<span class="token number">432</span>                      <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token number">433</span>                  <span class="token punctuation">}</span>
<span class="token number">434</span>              <span class="token punctuation">}</span>
<span class="token number">435</span>          <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token number">436</span>  
<span class="token number">437</span>          <span class="token comment">// package changes</span>
<span class="token number">438</span>          monitor<span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span>mContext<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span>  <span class="token class-name">UserHandle</span><span class="token punctuation">.</span>ALL<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">439</span>  
<span class="token number">440</span>          <span class="token comment">// user change and unlock</span>
<span class="token number">441</span>          <span class="token class-name">IntentFilter</span> intentFilter <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">IntentFilter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">442</span>          intentFilter<span class="token punctuation">.</span><span class="token function">addAction</span><span class="token punctuation">(</span><span class="token class-name">Intent</span><span class="token punctuation">.</span>ACTION_USER_SWITCHED<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">443</span>          intentFilter<span class="token punctuation">.</span><span class="token function">addAction</span><span class="token punctuation">(</span><span class="token class-name">Intent</span><span class="token punctuation">.</span>ACTION_USER_UNLOCKED<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">444</span>          intentFilter<span class="token punctuation">.</span><span class="token function">addAction</span><span class="token punctuation">(</span><span class="token class-name">Intent</span><span class="token punctuation">.</span>ACTION_USER_REMOVED<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">445</span>          intentFilter<span class="token punctuation">.</span><span class="token function">addAction</span><span class="token punctuation">(</span><span class="token class-name">Intent</span><span class="token punctuation">.</span>ACTION_USER_PRESENT<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">446</span>          intentFilter<span class="token punctuation">.</span><span class="token function">addAction</span><span class="token punctuation">(</span><span class="token class-name">Intent</span><span class="token punctuation">.</span>ACTION_SETTING_RESTORED<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">447</span>  
<span class="token number">448</span>          mContext<span class="token punctuation">.</span><span class="token function">registerReceiverAsUser</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">BroadcastReceiver</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">449</span>              <span class="token annotation punctuation">@Override</span>
<span class="token number">450</span>              <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onReceive</span><span class="token punctuation">(</span><span class="token class-name">Context</span> context<span class="token punctuation">,</span> <span class="token class-name">Intent</span> intent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">451</span>                  <span class="token class-name">String</span> action <span class="token operator">=</span> intent<span class="token punctuation">.</span><span class="token function">getAction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">452</span>                  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Intent</span><span class="token punctuation">.</span>ACTION_USER_SWITCHED<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>action<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">453</span>                      <span class="token function">switchUser</span><span class="token punctuation">(</span>intent<span class="token punctuation">.</span><span class="token function">getIntExtra</span><span class="token punctuation">(</span><span class="token class-name">Intent</span><span class="token punctuation">.</span>EXTRA_USER_HANDLE<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">454</span>                  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Intent</span><span class="token punctuation">.</span>ACTION_USER_UNLOCKED<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>action<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">455</span>                      <span class="token function">unlockUser</span><span class="token punctuation">(</span>intent<span class="token punctuation">.</span><span class="token function">getIntExtra</span><span class="token punctuation">(</span><span class="token class-name">Intent</span><span class="token punctuation">.</span>EXTRA_USER_HANDLE<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">456</span>                  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Intent</span><span class="token punctuation">.</span>ACTION_USER_REMOVED<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>action<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">457</span>                      <span class="token function">removeUser</span><span class="token punctuation">(</span>intent<span class="token punctuation">.</span><span class="token function">getIntExtra</span><span class="token punctuation">(</span><span class="token class-name">Intent</span><span class="token punctuation">.</span>EXTRA_USER_HANDLE<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">458</span>                  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Intent</span><span class="token punctuation">.</span>ACTION_USER_PRESENT<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>action<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">459</span>                      <span class="token comment">// We will update when the automation service dies.</span>
<span class="token number">460</span>                      <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>mLock<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">461</span>                          <span class="token class-name">UserState</span> userState <span class="token operator">=</span> <span class="token function">getCurrentUserStateLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">462</span>                          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">readConfigurationForUserStateLocked</span><span class="token punctuation">(</span>userState<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">463</span>                              <span class="token function">onUserStateChangedLocked</span><span class="token punctuation">(</span>userState<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">464</span>                          <span class="token punctuation">}</span>
<span class="token number">465</span>                      <span class="token punctuation">}</span>
<span class="token number">466</span>                  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Intent</span><span class="token punctuation">.</span>ACTION_SETTING_RESTORED<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>action<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">467</span>                      <span class="token keyword">final</span> <span class="token class-name">String</span> which <span class="token operator">=</span> intent<span class="token punctuation">.</span><span class="token function">getStringExtra</span><span class="token punctuation">(</span><span class="token class-name">Intent</span><span class="token punctuation">.</span>EXTRA_SETTING_NAME<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">468</span>                      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Settings</span><span class="token punctuation">.</span><span class="token class-name">Secure</span><span class="token punctuation">.</span>ENABLED_ACCESSIBILITY_SERVICES<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>which<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">469</span>                          <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>mLock<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">470</span>                              <span class="token function">restoreEnabledAccessibilityServicesLocked</span><span class="token punctuation">(</span>
<span class="token number">471</span>                                      intent<span class="token punctuation">.</span><span class="token function">getStringExtra</span><span class="token punctuation">(</span><span class="token class-name">Intent</span><span class="token punctuation">.</span>EXTRA_SETTING_PREVIOUS_VALUE<span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token number">472</span>                                      intent<span class="token punctuation">.</span><span class="token function">getStringExtra</span><span class="token punctuation">(</span><span class="token class-name">Intent</span><span class="token punctuation">.</span>EXTRA_SETTING_NEW_VALUE<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">473</span>                          <span class="token punctuation">}</span>
<span class="token number">474</span>                      <span class="token punctuation">}</span>
<span class="token number">475</span>                  <span class="token punctuation">}</span>
<span class="token number">476</span>              <span class="token punctuation">}</span>
<span class="token number">477</span>          <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token class-name">UserHandle</span><span class="token punctuation">.</span>ALL<span class="token punctuation">,</span> intentFilter<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">478</span>      <span class="token punctuation">}</span>
<span class="line-numbers-rows" aria-hidden="true"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div>
<p>这些状态的变化都会调用到AMS的<code>onUserStateChangedLocked()</code>。</p>
<p>在<code>onUserStateChangedLocked()</code>中，我们关注<code>updateServicesLocked(userState)</code>这个函数，其他的函数是一些特定状态的更新。</p>
<p><em>AccessibilityManagerService.java -- <code>onUserStateChangedLocked()</code></em></p>
<div class="_2Uzcx_"><button class="VJbwyy" aria-label="复制代码" type="button"><i class="anticon anticon-copy" aria-label="icon: copy"><svg xmlns="http://www.w3.org/2000/svg" class="" aria-hidden="true" fill="currentColor" viewBox="64 64 896 896" focusable="false" width="1em" height="1em" data-icon="copy"><path d="M 832 64 H 296 c -4.4 0 -8 3.6 -8 8 v 56 c 0 4.4 3.6 8 8 8 h 496 v 688 c 0 4.4 3.6 8 8 8 h 56 c 4.4 0 8 -3.6 8 -8 V 96 c 0 -17.7 -14.3 -32 -32 -32 Z M 704 192 H 192 c -17.7 0 -32 14.3 -32 32 v 530.7 c 0 8.5 3.4 16.6 9.4 22.6 l 173.3 173.3 c 2.2 2.2 4.7 4 7.4 5.5 v 1.9 h 4.2 c 3.5 1.3 7.2 2 11 2 H 704 c 17.7 0 32 -14.3 32 -32 V 224 c 0 -17.7 -14.3 -32 -32 -32 Z M 350 856.2 L 263.9 770 H 350 v 86.2 Z M 664 888 H 414 V 746 c 0 -22.1 -17.9 -40 -40 -40 H 232 V 264 h 432 v 624 Z" /></svg></i></button><pre class="line-numbers  language-java"><code class="java  language-java">          <span class="token comment">/**
1765       * Called when any property of the user state has changed.
1766       *
1767       * @param userState the new user state
1768       */</span>
<span class="token number">1769</span>      <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">onUserStateChangedLocked</span><span class="token punctuation">(</span><span class="token class-name">UserState</span> userState<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">1770</span>          <span class="token comment">// TODO: Remove this hack</span>
<span class="token number">1771</span>          mInitialized <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token number">1772</span>          <span class="token function">updateLegacyCapabilitiesLocked</span><span class="token punctuation">(</span>userState<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">1773</span>          <span class="token function">updateServicesLocked</span><span class="token punctuation">(</span>userState<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">1774</span>          <span class="token function">updateAccessibilityShortcutLocked</span><span class="token punctuation">(</span>userState<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">1775</span>          <span class="token function">updateWindowsForAccessibilityCallbackLocked</span><span class="token punctuation">(</span>userState<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">1776</span>          <span class="token function">updateAccessibilityFocusBehaviorLocked</span><span class="token punctuation">(</span>userState<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">1777</span>          <span class="token function">updateFilterKeyEventsLocked</span><span class="token punctuation">(</span>userState<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">1778</span>          <span class="token function">updateTouchExplorationLocked</span><span class="token punctuation">(</span>userState<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">1779</span>          <span class="token function">updatePerformGesturesLocked</span><span class="token punctuation">(</span>userState<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">1780</span>          <span class="token function">updateDisplayDaltonizerLocked</span><span class="token punctuation">(</span>userState<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">1781</span>          <span class="token function">updateDisplayInversionLocked</span><span class="token punctuation">(</span>userState<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">1782</span>          <span class="token function">updateMagnificationLocked</span><span class="token punctuation">(</span>userState<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">1783</span>          <span class="token function">updateSoftKeyboardShowModeLocked</span><span class="token punctuation">(</span>userState<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">1784</span>          <span class="token function">scheduleUpdateFingerprintGestureHandling</span><span class="token punctuation">(</span>userState<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">1785</span>          <span class="token function">scheduleUpdateInputFilter</span><span class="token punctuation">(</span>userState<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">1786</span>          <span class="token function">scheduleUpdateClientsIfNeededLocked</span><span class="token punctuation">(</span>userState<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">1787</span>          <span class="token function">updateRelevantEventsLocked</span><span class="token punctuation">(</span>userState<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">1788</span>          <span class="token function">updateAccessibilityButtonTargetsLocked</span><span class="token punctuation">(</span>userState<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">1789</span>      <span class="token punctuation">}</span>
<span class="line-numbers-rows" aria-hidden="true"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div>
<p><em>AccessibilityManagerService.java -- <code>updateServicesLocked(userState)</code></em></p>
<div class="_2Uzcx_"><button class="VJbwyy" aria-label="复制代码" type="button"><i class="anticon anticon-copy" aria-label="icon: copy"><svg xmlns="http://www.w3.org/2000/svg" class="" aria-hidden="true" fill="currentColor" viewBox="64 64 896 896" focusable="false" width="1em" height="1em" data-icon="copy"><path d="M 832 64 H 296 c -4.4 0 -8 3.6 -8 8 v 56 c 0 4.4 3.6 8 8 8 h 496 v 688 c 0 4.4 3.6 8 8 8 h 56 c 4.4 0 8 -3.6 8 -8 V 96 c 0 -17.7 -14.3 -32 -32 -32 Z M 704 192 H 192 c -17.7 0 -32 14.3 -32 32 v 530.7 c 0 8.5 3.4 16.6 9.4 22.6 l 173.3 173.3 c 2.2 2.2 4.7 4 7.4 5.5 v 1.9 h 4.2 c 3.5 1.3 7.2 2 11 2 H 704 c 17.7 0 32 -14.3 32 -32 V 224 c 0 -17.7 -14.3 -32 -32 -32 Z M 350 856.2 L 263.9 770 H 350 v 86.2 Z M 664 888 H 414 V 746 c 0 -22.1 -17.9 -40 -40 -40 H 232 V 264 h 432 v 624 Z" /></svg></i></button><pre class="line-numbers  language-java"><code class="java  language-java"><span class="token number">1541</span>        <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">updateServicesLocked</span><span class="token punctuation">(</span><span class="token class-name">UserState</span> userState<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">1542</span>          <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ComponentName</span><span class="token punctuation">,</span> <span class="token class-name">AccessibilityServiceConnection</span><span class="token punctuation">&gt;</span></span> componentNameToServiceMap <span class="token operator">=</span>
<span class="token number">1543</span>                  userState<span class="token punctuation">.</span>mComponentNameToServiceMap<span class="token punctuation">;</span>
<span class="token number">1544</span>          <span class="token keyword">boolean</span> isUnlockingOrUnlocked <span class="token operator">=</span> <span class="token class-name">LocalServices</span><span class="token punctuation">.</span><span class="token function">getService</span><span class="token punctuation">(</span><span class="token class-name">UserManagerInternal</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token number">1545</span>                      <span class="token punctuation">.</span><span class="token function">isUserUnlockingOrUnlocked</span><span class="token punctuation">(</span>userState<span class="token punctuation">.</span>mUserId<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">1546</span>  
<span class="token number">1547</span>          <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> count <span class="token operator">=</span> userState<span class="token punctuation">.</span>mInstalledServices<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> count<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">1548</span>              <span class="token class-name">AccessibilityServiceInfo</span> installedService <span class="token operator">=</span> userState<span class="token punctuation">.</span>mInstalledServices<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">1549</span>              <span class="token class-name">ComponentName</span> componentName <span class="token operator">=</span> <span class="token class-name">ComponentName</span><span class="token punctuation">.</span><span class="token function">unflattenFromString</span><span class="token punctuation">(</span>
<span class="token number">1550</span>                      installedService<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">1551</span>  
<span class="token number">1552</span>              <span class="token class-name">AccessibilityServiceConnection</span> service <span class="token operator">=</span> componentNameToServiceMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>componentName<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">1553</span>  
<span class="token number">1554</span>              <span class="token comment">// Ignore non-encryption-aware services until user is unlocked</span>
<span class="token number">1555</span>              <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isUnlockingOrUnlocked <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>installedService<span class="token punctuation">.</span><span class="token function">isDirectBootAware</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">1556</span>                  <span class="token class-name">Slog</span><span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span>LOG_TAG<span class="token punctuation">,</span> <span class="token string">"Ignoring non-encryption-aware service "</span> <span class="token operator">+</span> componentName<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">1557</span>                  <span class="token keyword">continue</span><span class="token punctuation">;</span>
<span class="token number">1558</span>              <span class="token punctuation">}</span>
<span class="token number">1559</span>  
<span class="token number">1560</span>              <span class="token comment">// Wait for the binding if it is in process.</span>
<span class="token number">1561</span>              <span class="token keyword">if</span> <span class="token punctuation">(</span>userState<span class="token punctuation">.</span>mBindingServices<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>componentName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">1562</span>                  <span class="token keyword">continue</span><span class="token punctuation">;</span>
<span class="token number">1563</span>              <span class="token punctuation">}</span>
<span class="token number">1564</span>              <span class="token keyword">if</span> <span class="token punctuation">(</span>userState<span class="token punctuation">.</span>mEnabledServices<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>componentName<span class="token punctuation">)</span>
<span class="token number">1565</span>                      <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>mUiAutomationManager<span class="token punctuation">.</span><span class="token function">suppressingAccessibilityServicesLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">1566</span>                  <span class="token keyword">if</span> <span class="token punctuation">(</span>service <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">1567</span>                      service <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AccessibilityServiceConnection</span><span class="token punctuation">(</span>userState<span class="token punctuation">,</span> mContext<span class="token punctuation">,</span> componentName<span class="token punctuation">,</span>
<span class="token number">1568</span>                              installedService<span class="token punctuation">,</span> sIdCounter<span class="token operator">++</span><span class="token punctuation">,</span> mMainHandler<span class="token punctuation">,</span> mLock<span class="token punctuation">,</span> mSecurityPolicy<span class="token punctuation">,</span>
<span class="token number">1569</span>                              <span class="token keyword">this</span><span class="token punctuation">,</span> mWindowManagerService<span class="token punctuation">,</span> mGlobalActionPerformer<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">1570</span>                  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>userState<span class="token punctuation">.</span>mBoundServices<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>service<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">1571</span>                      <span class="token keyword">continue</span><span class="token punctuation">;</span>
<span class="token number">1572</span>                  <span class="token punctuation">}</span>
<span class="token number">1573</span>                  service<span class="token punctuation">.</span><span class="token function">bindLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">1574</span>              <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
<span class="token number">1575</span>                  <span class="token keyword">if</span> <span class="token punctuation">(</span>service <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">1576</span>                      service<span class="token punctuation">.</span><span class="token function">unbindLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">1577</span>                  <span class="token punctuation">}</span>
<span class="token number">1578</span>              <span class="token punctuation">}</span>
<span class="token number">1579</span>          <span class="token punctuation">}</span>
<span class="token number">1580</span>  
<span class="token number">1581</span>          <span class="token keyword">final</span> <span class="token keyword">int</span> count <span class="token operator">=</span> userState<span class="token punctuation">.</span>mBoundServices<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">1582</span>          mTempIntArray<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">1583</span>          <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> count<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">1584</span>              <span class="token keyword">final</span> <span class="token class-name">ResolveInfo</span> resolveInfo <span class="token operator">=</span>
<span class="token number">1585</span>                      userState<span class="token punctuation">.</span>mBoundServices<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">.</span>mAccessibilityServiceInfo<span class="token punctuation">.</span><span class="token function">getResolveInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">1586</span>              <span class="token keyword">if</span> <span class="token punctuation">(</span>resolveInfo <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">1587</span>                  mTempIntArray<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>resolveInfo<span class="token punctuation">.</span>serviceInfo<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">.</span>uid<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">1588</span>              <span class="token punctuation">}</span>
<span class="token number">1589</span>          <span class="token punctuation">}</span>
<span class="token number">1590</span>          <span class="token comment">// Calling out with lock held, but to a lower-level service</span>
<span class="token number">1591</span>          <span class="token keyword">final</span> <span class="token class-name">AudioManagerInternal</span> audioManager <span class="token operator">=</span>
<span class="token number">1592</span>                  <span class="token class-name">LocalServices</span><span class="token punctuation">.</span><span class="token function">getService</span><span class="token punctuation">(</span><span class="token class-name">AudioManagerInternal</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">1593</span>          <span class="token keyword">if</span> <span class="token punctuation">(</span>audioManager <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">1594</span>              audioManager<span class="token punctuation">.</span><span class="token function">setAccessibilityServiceUids</span><span class="token punctuation">(</span>mTempIntArray<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">1595</span>          <span class="token punctuation">}</span>
<span class="token number">1596</span>          <span class="token function">updateAccessibilityEnabledSetting</span><span class="token punctuation">(</span>userState<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">1597</span>      <span class="token punctuation">}</span>
<span class="line-numbers-rows" aria-hidden="true"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div>
<p>这个函数做了很多判断，我画了一个流程图，首先要知道在AMS中，有这么几个List，看名字就知道每个List是什么意思了。<br>
mInstalledServices中，AccessibilityServiceInfo代表一个AccessibilityService的一些信息。<br>
mEnabledServices中，ComponentName包含了className和packageName，ComponentName信息可以通过AccessibilityServiceInfo得到。<br>
mComponentNameToServiceMap中，保存了ComponentName与AccessibilityServiceConnection的对应关系，每一个AccessibilityServiceConnection对应一个连接的AccessibilityService。</p>
<div class="_2Uzcx_"><button class="VJbwyy" aria-label="复制代码" type="button"><i class="anticon anticon-copy" aria-label="icon: copy"><svg xmlns="http://www.w3.org/2000/svg" class="" aria-hidden="true" fill="currentColor" viewBox="64 64 896 896" focusable="false" width="1em" height="1em" data-icon="copy"><path d="M 832 64 H 296 c -4.4 0 -8 3.6 -8 8 v 56 c 0 4.4 3.6 8 8 8 h 496 v 688 c 0 4.4 3.6 8 8 8 h 56 c 4.4 0 8 -3.6 8 -8 V 96 c 0 -17.7 -14.3 -32 -32 -32 Z M 704 192 H 192 c -17.7 0 -32 14.3 -32 32 v 530.7 c 0 8.5 3.4 16.6 9.4 22.6 l 173.3 173.3 c 2.2 2.2 4.7 4 7.4 5.5 v 1.9 h 4.2 c 3.5 1.3 7.2 2 11 2 H 704 c 17.7 0 32 -14.3 32 -32 V 224 c 0 -17.7 -14.3 -32 -32 -32 Z M 350 856.2 L 263.9 770 H 350 v 86.2 Z M 664 888 H 414 V 746 c 0 -22.1 -17.9 -40 -40 -40 H 232 V 264 h 432 v 624 Z" /></svg></i></button><pre class="line-numbers  language-java"><code class="java  language-java"><span class="token number">3650</span>    <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">AccessibilityServiceConnection</span><span class="token punctuation">&gt;</span></span> mBoundServices <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">3651</span>  
<span class="token number">3652</span>    <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ComponentName</span><span class="token punctuation">,</span> <span class="token class-name">AccessibilityServiceConnection</span><span class="token punctuation">&gt;</span></span> mComponentNameToServiceMap <span class="token operator">=</span>
<span class="token number">3653</span>                  <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">3654</span>  
<span class="token number">3655</span>    <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">AccessibilityServiceInfo</span><span class="token punctuation">&gt;</span></span> mInstalledServices <span class="token operator">=</span>
<span class="token number">3656</span>                  <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">3657</span>  
<span class="token number">3658</span>    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ComponentName</span><span class="token punctuation">&gt;</span></span> mBindingServices <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">3659</span>  
<span class="token number">3660</span>    <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ComponentName</span><span class="token punctuation">&gt;</span></span> mEnabledServices <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="line-numbers-rows" aria-hidden="true"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div>
<p>（1）先遍历mInstalledServices这个List，它会先判断，这个AccessibilityService是否绑定了，如果绑定了，处理下一个；<br>
（2）如果没有绑定了，会判断这个AccessibilityService是否处于enable状态，怎么判断是否处于enable状态呢？可以在mEnabledServices这个HashSet中查找。<br>
（2.1）如果是处于enable状态，会在mComponentNameToServiceMap中通过ComponentName查找对应的AccessibilityServiceConnection是否为空（也就是流程图中的service）<br>
（2.1.1）如果为空，会根据ComponentName，还有其他的一些信息new一个AccessibilityServiceConnection对象，然后调用里面的bindLocked()去绑定AccessibilityService。<br>
（2.1.2）如果不为空，则处理下一个<br>
（2.2）如果处于disable状态，会在mComponentNameToServiceMap中通过ComponentName查找对应的AccessibilityServiceConnection是否不为空（也就是流程图中的service）<br>
（2.2.1）如果为空，则处理下一个<br>
（2.2.2）如果不为空，会调用AccessibilityServiceConnection的unbindLocked()</p>
<div class="image-package">
<div class="image-container" style="max-height: 533px; max-width: 700px; background-color: transparent;">
<div class="image-container-fill" style="padding-bottom: 52.82%;"></div>
<div class="image-view" data-height="533" data-width="1009"><img src="images/android05707.jpg" data-image-index="5" data-original-filesize="52114" data-original-format="image/png" data-original-height="533" data-original-width="1009" data-original-src="//upload-images.jianshu.io/upload_images/4465577-3622e1eaffb179b2"></div>
</div>
<div class="image-caption">在这里插入图片描述</div>
</div>
<p><strong>Step2：绑定过程</strong></p>
<p><em>AccessibilityServiceConnection.java -- <code>bindLocked()</code></em></p>
<div class="_2Uzcx_"><button class="VJbwyy" aria-label="复制代码" type="button"><i class="anticon anticon-copy" aria-label="icon: copy"><svg xmlns="http://www.w3.org/2000/svg" class="" aria-hidden="true" fill="currentColor" viewBox="64 64 896 896" focusable="false" width="1em" height="1em" data-icon="copy"><path d="M 832 64 H 296 c -4.4 0 -8 3.6 -8 8 v 56 c 0 4.4 3.6 8 8 8 h 496 v 688 c 0 4.4 3.6 8 8 8 h 56 c 4.4 0 8 -3.6 8 -8 V 96 c 0 -17.7 -14.3 -32 -32 -32 Z M 704 192 H 192 c -17.7 0 -32 14.3 -32 32 v 530.7 c 0 8.5 3.4 16.6 9.4 22.6 l 173.3 173.3 c 2.2 2.2 4.7 4 7.4 5.5 v 1.9 h 4.2 c 3.5 1.3 7.2 2 11 2 H 704 c 17.7 0 32 -14.3 32 -32 V 224 c 0 -17.7 -14.3 -32 -32 -32 Z M 350 856.2 L 263.9 770 H 350 v 86.2 Z M 664 888 H 414 V 746 c 0 -22.1 -17.9 -40 -40 -40 H 232 V 264 h 432 v 624 Z" /></svg></i></button><pre class="line-numbers  language-java"><code class="java  language-java"><span class="token number">91</span>      <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">bindLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">92</span>          <span class="token class-name">UserState</span> userState <span class="token operator">=</span> mUserStateWeakReference<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">93</span>          <span class="token keyword">if</span> <span class="token punctuation">(</span>userState <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>
<span class="token number">94</span>          <span class="token keyword">final</span> <span class="token keyword">long</span> identity <span class="token operator">=</span> <span class="token class-name">Binder</span><span class="token punctuation">.</span><span class="token function">clearCallingIdentity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">95</span>          <span class="token keyword">try</span> <span class="token punctuation">{</span>
<span class="token number">96</span>              <span class="token keyword">int</span> flags <span class="token operator">=</span> <span class="token class-name">Context</span><span class="token punctuation">.</span>BIND_AUTO_CREATE <span class="token operator">|</span> <span class="token class-name">Context</span><span class="token punctuation">.</span>BIND_FOREGROUND_SERVICE_WHILE_AWAKE<span class="token punctuation">;</span>
<span class="token number">97</span>              <span class="token keyword">if</span> <span class="token punctuation">(</span>userState<span class="token punctuation">.</span>mBindInstantServiceAllowed<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">98</span>                  flags <span class="token operator">|=</span> <span class="token class-name">Context</span><span class="token punctuation">.</span>BIND_ALLOW_INSTANT<span class="token punctuation">;</span>
<span class="token number">99</span>              <span class="token punctuation">}</span>
<span class="token number">100</span>              <span class="token keyword">if</span> <span class="token punctuation">(</span>mService <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> mContext<span class="token punctuation">.</span><span class="token function">bindServiceAsUser</span><span class="token punctuation">(</span>
<span class="token number">101</span>                      mIntent<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">,</span> flags<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">UserHandle</span><span class="token punctuation">(</span>userState<span class="token punctuation">.</span>mUserId<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">102</span>                  userState<span class="token punctuation">.</span><span class="token function">getBindingServicesLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>mComponentName<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">103</span>              <span class="token punctuation">}</span>
<span class="token number">104</span>          <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
<span class="token number">105</span>              <span class="token class-name">Binder</span><span class="token punctuation">.</span><span class="token function">restoreCallingIdentity</span><span class="token punctuation">(</span>identity<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">106</span>          <span class="token punctuation">}</span>
<span class="token number">107</span>      <span class="token punctuation">}</span>
<span class="line-numbers-rows" aria-hidden="true"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div>
<p>进而调用到Context中的<code>bindServiceAsUser()</code>，它传入了Intent信息，这个Intent包含了ComponentName等信息，进而绑定了AS。接下来的过程其实就相当于是跨进程的IPC（也就是Binder了）。AS会通过<code>onBind(Intent intent)</code>这个函数返回一个IAccessibilityServiceClientWrapper对象给AccessibilityServiceConnection，这个对象就是AS的本地Binder，AccessibilityServiceConnection通过这个本地Binder去和AS通信。</p>
<div class="_2Uzcx_"><button class="VJbwyy" aria-label="复制代码" type="button"><i class="anticon anticon-copy" aria-label="icon: copy"><svg xmlns="http://www.w3.org/2000/svg" class="" aria-hidden="true" fill="currentColor" viewBox="64 64 896 896" focusable="false" width="1em" height="1em" data-icon="copy"><path d="M 832 64 H 296 c -4.4 0 -8 3.6 -8 8 v 56 c 0 4.4 3.6 8 8 8 h 496 v 688 c 0 4.4 3.6 8 8 8 h 56 c 4.4 0 8 -3.6 8 -8 V 96 c 0 -17.7 -14.3 -32 -32 -32 Z M 704 192 H 192 c -17.7 0 -32 14.3 -32 32 v 530.7 c 0 8.5 3.4 16.6 9.4 22.6 l 173.3 173.3 c 2.2 2.2 4.7 4 7.4 5.5 v 1.9 h 4.2 c 3.5 1.3 7.2 2 11 2 H 704 c 17.7 0 32 -14.3 32 -32 V 224 c 0 -17.7 -14.3 -32 -32 -32 Z M 350 856.2 L 263.9 770 H 350 v 86.2 Z M 664 888 H 414 V 746 c 0 -22.1 -17.9 -40 -40 -40 H 232 V 264 h 432 v 624 Z" /></svg></i></button><pre class="line-numbers  language-java"><code class="java  language-java"><span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">IAccessibilityServiceClientWrapper</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token function">getMainLooper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Callbacks</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="line-numbers-rows" aria-hidden="true"><span></span></span></code></pre></div>
<p>AccessibilityServiceConnection会在<code>onServiceConnected(ComponentName componentName, IBinder service)</code>的IBinder参数中传入IAccessibilityServiceClientWrapper，然后通过<code>IAccessibilityServiceClient.Stub.asInterface(service)</code>生成IAccessibilityServiceClient类型代理对象mServiceInterface，这个代理对象包含了AS的Callbacks函数，AMS通过这个代理对象去调用AS中的方法。</p>
<div class="_2Uzcx_"><button class="VJbwyy" aria-label="复制代码" type="button"><i class="anticon anticon-copy" aria-label="icon: copy"><svg xmlns="http://www.w3.org/2000/svg" class="" aria-hidden="true" fill="currentColor" viewBox="64 64 896 896" focusable="false" width="1em" height="1em" data-icon="copy"><path d="M 832 64 H 296 c -4.4 0 -8 3.6 -8 8 v 56 c 0 4.4 3.6 8 8 8 h 496 v 688 c 0 4.4 3.6 8 8 8 h 56 c 4.4 0 8 -3.6 8 -8 V 96 c 0 -17.7 -14.3 -32 -32 -32 Z M 704 192 H 192 c -17.7 0 -32 14.3 -32 32 v 530.7 c 0 8.5 3.4 16.6 9.4 22.6 l 173.3 173.3 c 2.2 2.2 4.7 4 7.4 5.5 v 1.9 h 4.2 c 3.5 1.3 7.2 2 11 2 H 704 c 17.7 0 32 -14.3 32 -32 V 224 c 0 -17.7 -14.3 -32 -32 -32 Z M 350 856.2 L 263.9 770 H 350 v 86.2 Z M 664 888 H 414 V 746 c 0 -22.1 -17.9 -40 -40 -40 H 232 V 264 h 432 v 624 Z" /></svg></i></button><pre class="line-numbers  language-java"><code class="java  language-java"><span class="token number">141</span>      <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onServiceConnected</span><span class="token punctuation">(</span><span class="token class-name">ComponentName</span> componentName<span class="token punctuation">,</span> <span class="token class-name">IBinder</span> service<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">142</span>          <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>mLock<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">143</span>              <span class="token keyword">if</span> <span class="token punctuation">(</span>mService <span class="token operator">!=</span> service<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">144</span>                  <span class="token keyword">if</span> <span class="token punctuation">(</span>mService <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">145</span>                      mService<span class="token punctuation">.</span><span class="token function">unlinkToDeath</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">146</span>                  <span class="token punctuation">}</span>
<span class="token number">147</span>                  mService <span class="token operator">=</span> service<span class="token punctuation">;</span>
<span class="token number">148</span>                  <span class="token keyword">try</span> <span class="token punctuation">{</span>
<span class="token number">149</span>                      mService<span class="token punctuation">.</span><span class="token function">linkToDeath</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">150</span>                  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RemoteException</span> re<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">151</span>                      <span class="token class-name">Slog</span><span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span>LOG_TAG<span class="token punctuation">,</span> <span class="token string">"Failed registering death link"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">152</span>                      <span class="token function">binderDied</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">153</span>                      <span class="token keyword">return</span><span class="token punctuation">;</span>
<span class="token number">154</span>                  <span class="token punctuation">}</span>
<span class="token number">155</span>              <span class="token punctuation">}</span>
<span class="token number">156</span>              mServiceInterface <span class="token operator">=</span> <span class="token class-name">IAccessibilityServiceClient</span><span class="token punctuation">.</span><span class="token class-name">Stub</span><span class="token punctuation">.</span><span class="token function">asInterface</span><span class="token punctuation">(</span>service<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">157</span>              <span class="token class-name">UserState</span> userState <span class="token operator">=</span> mUserStateWeakReference<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">158</span>              <span class="token keyword">if</span> <span class="token punctuation">(</span>userState <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>
<span class="token number">159</span>              userState<span class="token punctuation">.</span><span class="token function">addServiceLocked</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">160</span>              mSystemSupport<span class="token punctuation">.</span><span class="token function">onClientChange</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">161</span>              <span class="token comment">// Initialize the service on the main handler after we're done setting up for</span>
<span class="token number">162</span>              <span class="token comment">// the new configuration (for example, initializing the input filter).</span>
<span class="token number">163</span>              mMainHandler<span class="token punctuation">.</span><span class="token function">sendMessage</span><span class="token punctuation">(</span><span class="token function">obtainMessage</span><span class="token punctuation">(</span>
<span class="token number">164</span>                      <span class="token class-name">AccessibilityServiceConnection</span><span class="token operator">:</span><span class="token operator">:</span><span class="token function">initializeService</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">165</span>          <span class="token punctuation">}</span>
<span class="token number">166</span>      <span class="token punctuation">}</span>
<span class="line-numbers-rows" aria-hidden="true"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div>
<p><em>AccessibilityService.java -- Callbacks{}</em><br>
AS中的Callbacks函数接口</p>
<div class="_2Uzcx_"><button class="VJbwyy" aria-label="复制代码" type="button"><i class="anticon anticon-copy" aria-label="icon: copy"><svg xmlns="http://www.w3.org/2000/svg" class="" aria-hidden="true" fill="currentColor" viewBox="64 64 896 896" focusable="false" width="1em" height="1em" data-icon="copy"><path d="M 832 64 H 296 c -4.4 0 -8 3.6 -8 8 v 56 c 0 4.4 3.6 8 8 8 h 496 v 688 c 0 4.4 3.6 8 8 8 h 56 c 4.4 0 8 -3.6 8 -8 V 96 c 0 -17.7 -14.3 -32 -32 -32 Z M 704 192 H 192 c -17.7 0 -32 14.3 -32 32 v 530.7 c 0 8.5 3.4 16.6 9.4 22.6 l 173.3 173.3 c 2.2 2.2 4.7 4 7.4 5.5 v 1.9 h 4.2 c 3.5 1.3 7.2 2 11 2 H 704 c 17.7 0 32 -14.3 32 -32 V 224 c 0 -17.7 -14.3 -32 -32 -32 Z M 350 856.2 L 263.9 770 H 350 v 86.2 Z M 664 888 H 414 V 746 c 0 -22.1 -17.9 -40 -40 -40 H 232 V 264 h 432 v 624 Z" /></svg></i></button><pre class="line-numbers  language-java"><code class="java  language-java"><span class="token number">373</span>     <span class="token comment">/**
374       * Interface used by IAccessibilityServiceWrapper to call the service from its main thread.
375       * @hide
376       */</span>
<span class="token number">377</span>      <span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">Callbacks</span> <span class="token punctuation">{</span>
<span class="token number">378</span>          <span class="token keyword">void</span> <span class="token function">onAccessibilityEvent</span><span class="token punctuation">(</span><span class="token class-name">AccessibilityEvent</span> event<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">379</span>          <span class="token keyword">void</span> <span class="token function">onInterrupt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">380</span>          <span class="token keyword">void</span> <span class="token function">onServiceConnected</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">381</span>          <span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token keyword">int</span> connectionId<span class="token punctuation">,</span> <span class="token class-name">IBinder</span> windowToken<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">382</span>          <span class="token keyword">boolean</span> <span class="token function">onGesture</span><span class="token punctuation">(</span><span class="token keyword">int</span> gestureId<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">383</span>          <span class="token keyword">boolean</span> <span class="token function">onKeyEvent</span><span class="token punctuation">(</span><span class="token class-name">KeyEvent</span> event<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">384</span>          <span class="token keyword">void</span> <span class="token function">onMagnificationChanged</span><span class="token punctuation">(</span><span class="token annotation punctuation">@NonNull</span> <span class="token class-name">Region</span> region<span class="token punctuation">,</span>
<span class="token number">385</span>                  <span class="token keyword">float</span> scale<span class="token punctuation">,</span> <span class="token keyword">float</span> centerX<span class="token punctuation">,</span> <span class="token keyword">float</span> centerY<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">386</span>          <span class="token keyword">void</span> <span class="token function">onSoftKeyboardShowModeChanged</span><span class="token punctuation">(</span><span class="token keyword">int</span> showMode<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">387</span>          <span class="token keyword">void</span> <span class="token function">onPerformGestureResult</span><span class="token punctuation">(</span><span class="token keyword">int</span> sequence<span class="token punctuation">,</span> <span class="token keyword">boolean</span> completedSuccessfully<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">388</span>          <span class="token keyword">void</span> <span class="token function">onFingerprintCapturingGesturesChanged</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> active<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">389</span>          <span class="token keyword">void</span> <span class="token function">onFingerprintGesture</span><span class="token punctuation">(</span><span class="token keyword">int</span> gesture<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">390</span>          <span class="token keyword">void</span> <span class="token function">onAccessibilityButtonClicked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">391</span>          <span class="token keyword">void</span> <span class="token function">onAccessibilityButtonAvailabilityChanged</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> available<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">392</span>      <span class="token punctuation">}</span>
<span class="line-numbers-rows" aria-hidden="true"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div>
<p>下面的图可能清晰一点。</p>
<br>
<div class="image-package">
<div class="image-container" style="max-height: 508px; max-width: 700px; background-color: transparent;">
<div class="image-container-fill" style="padding-bottom: 58.66%;"></div>
<div class="image-view" data-height="508" data-width="866"><img src="images/android05708.jpg" data-image-index="6" data-original-filesize="81734" data-original-format="image/png" data-original-height="508" data-original-width="866" data-original-src="//upload-images.jianshu.io/upload_images/4465577-18116e874f478299"></div>
</div>
<div class="image-caption">在这里插入图片描述</div>
</div>
<p>以上就是AMS和AS连接的过程。</p>
<h1>AM与AMS联系</h1>
<p>其实也是一个Binder的过程啦，AM通过IAccessibilityManager（AMS的本地Binder）与AMS跨进程通信。AMS通过IAccessibilityManagerClient（AM的本地Binder）与AM通信。</p>
<br>
<div class="image-package">
<div class="image-container" style="max-height: 262px; max-width: 700px; background-color: transparent;">
<div class="image-container-fill" style="padding-bottom: 31.41%;"></div>
<div class="image-view" data-height="262" data-width="834"><img src="images/android05709.jpg" data-image-index="7" data-original-filesize="21850" data-original-format="image/png" data-original-height="262" data-original-width="834" data-original-src="//upload-images.jianshu.io/upload_images/4465577-82e84cfb2132ce75"></div>
</div>
<div class="image-caption">在这里插入图片描述</div>
</div>
<p>来看代码，当Target APP触发一个AccessibilityEvent（这个等会详细说），它会new一个AM的实例。</p>
<div class="_2Uzcx_"><button class="VJbwyy" aria-label="复制代码" type="button"><i class="anticon anticon-copy" aria-label="icon: copy"><svg xmlns="http://www.w3.org/2000/svg" class="" aria-hidden="true" fill="currentColor" viewBox="64 64 896 896" focusable="false" width="1em" height="1em" data-icon="copy"><path d="M 832 64 H 296 c -4.4 0 -8 3.6 -8 8 v 56 c 0 4.4 3.6 8 8 8 h 496 v 688 c 0 4.4 3.6 8 8 8 h 56 c 4.4 0 8 -3.6 8 -8 V 96 c 0 -17.7 -14.3 -32 -32 -32 Z M 704 192 H 192 c -17.7 0 -32 14.3 -32 32 v 530.7 c 0 8.5 3.4 16.6 9.4 22.6 l 173.3 173.3 c 2.2 2.2 4.7 4 7.4 5.5 v 1.9 h 4.2 c 3.5 1.3 7.2 2 11 2 H 704 c 17.7 0 32 -14.3 32 -32 V 224 c 0 -17.7 -14.3 -32 -32 -32 Z M 350 856.2 L 263.9 770 H 350 v 86.2 Z M 664 888 H 414 V 746 c 0 -22.1 -17.9 -40 -40 -40 H 232 V 264 h 432 v 624 Z" /></svg></i></button><pre class="line-numbers  language-java"><code class="java  language-java"><span class="token number">321</span>      <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">AccessibilityManager</span> <span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token class-name">Context</span> context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">322</span>          <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>sInstanceSync<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">323</span>              <span class="token keyword">if</span> <span class="token punctuation">(</span>sInstance <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">324</span>                  <span class="token keyword">final</span> <span class="token keyword">int</span> userId<span class="token punctuation">;</span>
<span class="token number">325</span>                  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Binder</span><span class="token punctuation">.</span><span class="token function">getCallingUid</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token class-name">Process</span><span class="token punctuation">.</span>SYSTEM_UID
<span class="token number">326</span>                          <span class="token operator">||</span> context<span class="token punctuation">.</span><span class="token function">checkCallingOrSelfPermission</span><span class="token punctuation">(</span>
<span class="token number">327</span>                                  <span class="token class-name">Manifest</span><span class="token punctuation">.</span>permission<span class="token punctuation">.</span>INTERACT_ACROSS_USERS<span class="token punctuation">)</span>
<span class="token number">328</span>                                          <span class="token operator">==</span> <span class="token class-name">PackageManager</span><span class="token punctuation">.</span>PERMISSION_GRANTED
<span class="token number">329</span>                          <span class="token operator">||</span> context<span class="token punctuation">.</span><span class="token function">checkCallingOrSelfPermission</span><span class="token punctuation">(</span>
<span class="token number">330</span>                                  <span class="token class-name">Manifest</span><span class="token punctuation">.</span>permission<span class="token punctuation">.</span>INTERACT_ACROSS_USERS_FULL<span class="token punctuation">)</span>
<span class="token number">331</span>                                          <span class="token operator">==</span> <span class="token class-name">PackageManager</span><span class="token punctuation">.</span>PERMISSION_GRANTED<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">332</span>                      userId <span class="token operator">=</span> <span class="token class-name">UserHandle</span><span class="token punctuation">.</span>USER_CURRENT<span class="token punctuation">;</span>
<span class="token number">333</span>                  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
<span class="token number">334</span>                      userId <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">335</span>                  <span class="token punctuation">}</span>
<span class="token number">336</span>                  sInstance <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AccessibilityManager</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">337</span>              <span class="token punctuation">}</span>
<span class="token number">338</span>          <span class="token punctuation">}</span>
<span class="token number">339</span>          <span class="token keyword">return</span> sInstance<span class="token punctuation">;</span>
<span class="token number">340</span>      <span class="token punctuation">}</span>
<span class="line-numbers-rows" aria-hidden="true"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div>
<p>AccessibilityManager的构造函数，然后会调用<code>tryConnectToServiceLocked()</code>函数。</p>
<p><em>AccessibilityManager.java -- AccessibilityManager()</em></p>
<div class="_2Uzcx_"><button class="VJbwyy" aria-label="复制代码" type="button"><i class="anticon anticon-copy" aria-label="icon: copy"><svg xmlns="http://www.w3.org/2000/svg" class="" aria-hidden="true" fill="currentColor" viewBox="64 64 896 896" focusable="false" width="1em" height="1em" data-icon="copy"><path d="M 832 64 H 296 c -4.4 0 -8 3.6 -8 8 v 56 c 0 4.4 3.6 8 8 8 h 496 v 688 c 0 4.4 3.6 8 8 8 h 56 c 4.4 0 8 -3.6 8 -8 V 96 c 0 -17.7 -14.3 -32 -32 -32 Z M 704 192 H 192 c -17.7 0 -32 14.3 -32 32 v 530.7 c 0 8.5 3.4 16.6 9.4 22.6 l 173.3 173.3 c 2.2 2.2 4.7 4 7.4 5.5 v 1.9 h 4.2 c 3.5 1.3 7.2 2 11 2 H 704 c 17.7 0 32 -14.3 32 -32 V 224 c 0 -17.7 -14.3 -32 -32 -32 Z M 350 856.2 L 263.9 770 H 350 v 86.2 Z M 664 888 H 414 V 746 c 0 -22.1 -17.9 -40 -40 -40 H 232 V 264 h 432 v 624 Z" /></svg></i></button><pre class="line-numbers  language-java"><code class="java  language-java"><span class="token number">351</span>     <span class="token keyword">public</span> <span class="token class-name">AccessibilityManager</span><span class="token punctuation">(</span><span class="token class-name">Context</span> context<span class="token punctuation">,</span> <span class="token class-name">IAccessibilityManager</span> service<span class="token punctuation">,</span> <span class="token keyword">int</span> userId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">352</span>          <span class="token comment">// Constructor can't be chained because we can't create an instance of an inner class</span>
<span class="token number">353</span>          <span class="token comment">// before calling another constructor.</span>
<span class="token number">354</span>          mCallback <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MyCallback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">355</span>          mHandler <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Handler</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">getMainLooper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> mCallback<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">356</span>          mUserId <span class="token operator">=</span> userId<span class="token punctuation">;</span>
<span class="token number">357</span>          <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>mLock<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">358</span>              <span class="token function">tryConnectToServiceLocked</span><span class="token punctuation">(</span>service<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">359</span>          <span class="token punctuation">}</span>
<span class="token number">360</span>      <span class="token punctuation">}</span>
<span class="line-numbers-rows" aria-hidden="true"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div>
<p>在<code>tryConnectToServiceLocked()</code>中，不仅会得到AMS的本地Binder（函数中的service），会通过<code>addClient(mClient, mUserId)</code>这个函数把自己的信息注册进去。</p>
<p><em>AccessibilityManager.java -- tryConnectToServiceLocked()</em></p>
<div class="_2Uzcx_"><button class="VJbwyy" aria-label="复制代码" type="button"><i class="anticon anticon-copy" aria-label="icon: copy"><svg xmlns="http://www.w3.org/2000/svg" class="" aria-hidden="true" fill="currentColor" viewBox="64 64 896 896" focusable="false" width="1em" height="1em" data-icon="copy"><path d="M 832 64 H 296 c -4.4 0 -8 3.6 -8 8 v 56 c 0 4.4 3.6 8 8 8 h 496 v 688 c 0 4.4 3.6 8 8 8 h 56 c 4.4 0 8 -3.6 8 -8 V 96 c 0 -17.7 -14.3 -32 -32 -32 Z M 704 192 H 192 c -17.7 0 -32 14.3 -32 32 v 530.7 c 0 8.5 3.4 16.6 9.4 22.6 l 173.3 173.3 c 2.2 2.2 4.7 4 7.4 5.5 v 1.9 h 4.2 c 3.5 1.3 7.2 2 11 2 H 704 c 17.7 0 32 -14.3 32 -32 V 224 c 0 -17.7 -14.3 -32 -32 -32 Z M 350 856.2 L 263.9 770 H 350 v 86.2 Z M 664 888 H 414 V 746 c 0 -22.1 -17.9 -40 -40 -40 H 232 V 264 h 432 v 624 Z" /></svg></i></button><pre class="line-numbers  language-java"><code class="java  language-java"><span class="token number">1115</span>    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">tryConnectToServiceLocked</span><span class="token punctuation">(</span><span class="token class-name">IAccessibilityManager</span> service<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">1116</span>          <span class="token keyword">if</span> <span class="token punctuation">(</span>service <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">1117</span>              <span class="token class-name">IBinder</span> iBinder <span class="token operator">=</span> <span class="token class-name">ServiceManager</span><span class="token punctuation">.</span><span class="token function">getService</span><span class="token punctuation">(</span><span class="token class-name">Context</span><span class="token punctuation">.</span>ACCESSIBILITY_SERVICE<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">1118</span>              <span class="token keyword">if</span> <span class="token punctuation">(</span>iBinder <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">1119</span>                  <span class="token keyword">return</span><span class="token punctuation">;</span>
<span class="token number">1120</span>              <span class="token punctuation">}</span>
<span class="token number">1121</span>              service <span class="token operator">=</span> <span class="token class-name">IAccessibilityManager</span><span class="token punctuation">.</span><span class="token class-name">Stub</span><span class="token punctuation">.</span><span class="token function">asInterface</span><span class="token punctuation">(</span>iBinder<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">1122</span>          <span class="token punctuation">}</span>
<span class="token number">1123</span>  
<span class="token number">1124</span>          <span class="token keyword">try</span> <span class="token punctuation">{</span>
<span class="token number">1125</span>              <span class="token keyword">final</span> <span class="token keyword">long</span> userStateAndRelevantEvents <span class="token operator">=</span> service<span class="token punctuation">.</span><span class="token function">addClient</span><span class="token punctuation">(</span>mClient<span class="token punctuation">,</span> mUserId<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">1126</span>              <span class="token function">setStateLocked</span><span class="token punctuation">(</span><span class="token class-name">IntPair</span><span class="token punctuation">.</span><span class="token function">first</span><span class="token punctuation">(</span>userStateAndRelevantEvents<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">1127</span>              mRelevantEventTypes <span class="token operator">=</span> <span class="token class-name">IntPair</span><span class="token punctuation">.</span><span class="token function">second</span><span class="token punctuation">(</span>userStateAndRelevantEvents<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">1128</span>              mService <span class="token operator">=</span> service<span class="token punctuation">;</span>
<span class="token number">1129</span>          <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RemoteException</span> re<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">1130</span>              <span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span>LOG_TAG<span class="token punctuation">,</span> <span class="token string">"AccessibilityManagerService is dead"</span><span class="token punctuation">,</span> re<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">1131</span>          <span class="token punctuation">}</span>
<span class="token number">1132</span>      <span class="token punctuation">}</span>
<span class="line-numbers-rows" aria-hidden="true"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div>
<p><code>mClient</code>是一个<code>IAccessibilityManagerClient</code>类型的本地Binder</p>
<div class="_2Uzcx_"><button class="VJbwyy" aria-label="复制代码" type="button"><i class="anticon anticon-copy" aria-label="icon: copy"><svg xmlns="http://www.w3.org/2000/svg" class="" aria-hidden="true" fill="currentColor" viewBox="64 64 896 896" focusable="false" width="1em" height="1em" data-icon="copy"><path d="M 832 64 H 296 c -4.4 0 -8 3.6 -8 8 v 56 c 0 4.4 3.6 8 8 8 h 496 v 688 c 0 4.4 3.6 8 8 8 h 56 c 4.4 0 8 -3.6 8 -8 V 96 c 0 -17.7 -14.3 -32 -32 -32 Z M 704 192 H 192 c -17.7 0 -32 14.3 -32 32 v 530.7 c 0 8.5 3.4 16.6 9.4 22.6 l 173.3 173.3 c 2.2 2.2 4.7 4 7.4 5.5 v 1.9 h 4.2 c 3.5 1.3 7.2 2 11 2 H 704 c 17.7 0 32 -14.3 32 -32 V 224 c 0 -17.7 -14.3 -32 -32 -32 Z M 350 856.2 L 263.9 770 H 350 v 86.2 Z M 664 888 H 414 V 746 c 0 -22.1 -17.9 -40 -40 -40 H 232 V 264 h 432 v 624 Z" /></svg></i></button><pre class="line-numbers  language-java"><code class="java  language-java"><span class="token number">276</span>          <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">IAccessibilityManagerClient</span><span class="token punctuation">.</span><span class="token class-name">Stub</span> mClient <span class="token operator">=</span>
<span class="token number">277</span>              <span class="token keyword">new</span> <span class="token class-name">IAccessibilityManagerClient</span><span class="token punctuation">.</span><span class="token class-name">Stub</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="line-numbers-rows" aria-hidden="true"><span></span><span></span></span></code></pre></div>
<p>下面的图也许更清楚一点，但总感觉哪里有点不对劲。</p>
<br>
<div class="image-package">
<div class="image-container" style="max-height: 508px; max-width: 599px; background-color: transparent;">
<div class="image-container-fill" style="padding-bottom: 84.81%;"></div>
<div class="image-view" data-height="508" data-width="599"><img src="images/android05710.jpg" data-image-index="8" data-original-filesize="22747" data-original-format="image/png" data-original-height="508" data-original-width="599" data-original-src="//upload-images.jianshu.io/upload_images/4465577-f97689cb5658fbfb"></div>
</div>
<div class="image-caption">在这里插入图片描述</div>
</div>
<h1>AccessibilityEvent Dispatch</h1>
<p>整个过程从事件触发一直到响应，走过了很长的路，因此我把它分成三个部分：</p>
<ul>
<li>AccessibilityEvent Trigger</li>
<li>AccessibilityEvent Dispatch</li>
<li>AccessibilityEvent Response</li>
</ul>
<div class="image-package">
<div class="image-container" style="max-height: 590px; max-width: 700px; background-color: transparent;">
<div class="image-container-fill" style="padding-bottom: 37.99%;"></div>
<div class="image-view" data-height="590" data-width="1553"><img src="images/android05711.jpg" data-image-index="9" data-original-filesize="69920" data-original-format="image/png" data-original-height="590" data-original-width="1553" data-original-src="//upload-images.jianshu.io/upload_images/4465577-b3989efa98d2e443"></div>
</div>
<div class="image-caption">在这里插入图片描述</div>
</div>
<h2>AccessibilityEvent Trigger</h2>
<p>这一部分，是当有一个AccessibilityEvent触发后，怎么到的AMS里面。先来看看AccessibilityEvent哪些类型。这些类型包括很多种，比如点击，手势，焦点等等。</p>
<div class="image-package">
<div class="image-container" style="max-height: 911px; max-width: 563px; background-color: transparent;">
<div class="image-container-fill" style="padding-bottom: 130.2%;"></div>
<div class="image-view" data-height="733" data-width="563"><img src="images/android05712.jpg" data-image-index="10" data-original-filesize="119006" data-original-format="image/png" data-original-height="733" data-original-width="563" data-original-src="//upload-images.jianshu.io/upload_images/4465577-85840b630d2245a3"></div>
</div>
<div class="image-caption">在这里插入图片描述</div>
</div>
<p>当用户的一些操作比如click，触发了Event（这时还不是AccessibilityEvent），会调用<code>sendAccessibilityEvent()</code>。</p>
<p><em>View.java -- performClick()</em></p>
<div class="_2Uzcx_"><button class="VJbwyy" aria-label="复制代码" type="button"><i class="anticon anticon-copy" aria-label="icon: copy"><svg xmlns="http://www.w3.org/2000/svg" class="" aria-hidden="true" fill="currentColor" viewBox="64 64 896 896" focusable="false" width="1em" height="1em" data-icon="copy"><path d="M 832 64 H 296 c -4.4 0 -8 3.6 -8 8 v 56 c 0 4.4 3.6 8 8 8 h 496 v 688 c 0 4.4 3.6 8 8 8 h 56 c 4.4 0 8 -3.6 8 -8 V 96 c 0 -17.7 -14.3 -32 -32 -32 Z M 704 192 H 192 c -17.7 0 -32 14.3 -32 32 v 530.7 c 0 8.5 3.4 16.6 9.4 22.6 l 173.3 173.3 c 2.2 2.2 4.7 4 7.4 5.5 v 1.9 h 4.2 c 3.5 1.3 7.2 2 11 2 H 704 c 17.7 0 32 -14.3 32 -32 V 224 c 0 -17.7 -14.3 -32 -32 -32 Z M 350 856.2 L 263.9 770 H 350 v 86.2 Z M 664 888 H 414 V 746 c 0 -22.1 -17.9 -40 -40 -40 H 232 V 264 h 432 v 624 Z" /></svg></i></button><pre class="line-numbers  language-java"><code class="java  language-java"><span class="token number">6590</span>      <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">performClick</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">6591</span>          <span class="token comment">// We still need to call this method to handle the cases where performClick() was called</span>
<span class="token number">6592</span>          <span class="token comment">// externally, instead of through performClickInternal()</span>
<span class="token number">6593</span>          <span class="token function">notifyAutofillManagerOnClick</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">6594</span>  
<span class="token number">6595</span>          <span class="token keyword">final</span> <span class="token keyword">boolean</span> result<span class="token punctuation">;</span>
<span class="token number">6596</span>          <span class="token keyword">final</span> <span class="token class-name">ListenerInfo</span> li <span class="token operator">=</span> mListenerInfo<span class="token punctuation">;</span>
<span class="token number">6597</span>          <span class="token keyword">if</span> <span class="token punctuation">(</span>li <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> li<span class="token punctuation">.</span>mOnClickListener <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">6598</span>              <span class="token function">playSoundEffect</span><span class="token punctuation">(</span><span class="token class-name">SoundEffectConstants</span><span class="token punctuation">.</span>CLICK<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">6599</span>              <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">ViewDebugManager</span><span class="token punctuation">.</span>DEBUG_TOUCH<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">6600</span>                  <span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span>VIEW_LOG_TAG<span class="token punctuation">,</span> <span class="token string">"(View)performClick, listener = "</span> <span class="token operator">+</span> li<span class="token punctuation">.</span>mOnClickListener
<span class="token number">6601</span>                          <span class="token operator">+</span> <span class="token string">",this = "</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">6602</span>              <span class="token punctuation">}</span>
<span class="token number">6603</span>              li<span class="token punctuation">.</span>mOnClickListener<span class="token punctuation">.</span><span class="token function">onClick</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">6604</span>              result <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token number">6605</span>          <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
<span class="token number">6606</span>              result <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token number">6607</span>          <span class="token punctuation">}</span>
<span class="token number">6608</span>  
<span class="token number">6609</span>          <span class="token function">sendAccessibilityEvent</span><span class="token punctuation">(</span><span class="token class-name">AccessibilityEvent</span><span class="token punctuation">.</span>TYPE_VIEW_CLICKED<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">6610</span>  
<span class="token number">6611</span>          <span class="token function">notifyEnterOrExitForAutoFillIfNeeded</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">6612</span>  
<span class="token number">6613</span>          <span class="token keyword">return</span> result<span class="token punctuation">;</span>
<span class="token number">6614</span>      <span class="token punctuation">}</span>
<span class="line-numbers-rows" aria-hidden="true"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div>
<p>再来看<code>sendAccessibilityEvent()</code>里面做了什么，这个AccessibilityDelegate我不知道具体是什么意思，可看<a href="https://developer.android.com/reference/android/view/View.AccessibilityDelegate" target="_blank" rel="nofollow">官网解释</a>，这里可以暂时先不用管它，然后可以看到它调用了<code>sendAccessibilityEventInternal()</code>。</p>
<p><em>View.java -- sendAccessibilityEvent()</em></p>
<div class="_2Uzcx_"><button class="VJbwyy" aria-label="复制代码" type="button"><i class="anticon anticon-copy" aria-label="icon: copy"><svg xmlns="http://www.w3.org/2000/svg" class="" aria-hidden="true" fill="currentColor" viewBox="64 64 896 896" focusable="false" width="1em" height="1em" data-icon="copy"><path d="M 832 64 H 296 c -4.4 0 -8 3.6 -8 8 v 56 c 0 4.4 3.6 8 8 8 h 496 v 688 c 0 4.4 3.6 8 8 8 h 56 c 4.4 0 8 -3.6 8 -8 V 96 c 0 -17.7 -14.3 -32 -32 -32 Z M 704 192 H 192 c -17.7 0 -32 14.3 -32 32 v 530.7 c 0 8.5 3.4 16.6 9.4 22.6 l 173.3 173.3 c 2.2 2.2 4.7 4 7.4 5.5 v 1.9 h 4.2 c 3.5 1.3 7.2 2 11 2 H 704 c 17.7 0 32 -14.3 32 -32 V 224 c 0 -17.7 -14.3 -32 -32 -32 Z M 350 856.2 L 263.9 770 H 350 v 86.2 Z M 664 888 H 414 V 746 c 0 -22.1 -17.9 -40 -40 -40 H 232 V 264 h 432 v 624 Z" /></svg></i></button><pre class="line-numbers  language-java"><code class="java  language-java"><span class="token number">7374</span>      <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">sendAccessibilityEvent</span><span class="token punctuation">(</span><span class="token keyword">int</span> eventType<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">7375</span>          <span class="token keyword">if</span> <span class="token punctuation">(</span>mAccessibilityDelegate <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">7376</span>              mAccessibilityDelegate<span class="token punctuation">.</span><span class="token function">sendAccessibilityEvent</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> eventType<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">7377</span>          <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
<span class="token number">7378</span>              <span class="token function">sendAccessibilityEventInternal</span><span class="token punctuation">(</span>eventType<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">7379</span>          <span class="token punctuation">}</span>
<span class="token number">7380</span>      <span class="token punctuation">}</span>
<span class="line-numbers-rows" aria-hidden="true"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div>
<p>在<code>sendAccessibilityEventInternal()</code>中，创建了一个AM的实例，<strong>在AM与AMS联系</strong>这一节讲到，创建实例的时候会与AMS通过Binder连接，然后这里会判断是否enable状态，再调用<code>sendAccessibilityEventUnchecked()</code>函数。</p>
<p><em>View.java -- sendAccessibilityEventInternal()</em></p>
<div class="_2Uzcx_"><button class="VJbwyy" aria-label="复制代码" type="button"><i class="anticon anticon-copy" aria-label="icon: copy"><svg xmlns="http://www.w3.org/2000/svg" class="" aria-hidden="true" fill="currentColor" viewBox="64 64 896 896" focusable="false" width="1em" height="1em" data-icon="copy"><path d="M 832 64 H 296 c -4.4 0 -8 3.6 -8 8 v 56 c 0 4.4 3.6 8 8 8 h 496 v 688 c 0 4.4 3.6 8 8 8 h 56 c 4.4 0 8 -3.6 8 -8 V 96 c 0 -17.7 -14.3 -32 -32 -32 Z M 704 192 H 192 c -17.7 0 -32 14.3 -32 32 v 530.7 c 0 8.5 3.4 16.6 9.4 22.6 l 173.3 173.3 c 2.2 2.2 4.7 4 7.4 5.5 v 1.9 h 4.2 c 3.5 1.3 7.2 2 11 2 H 704 c 17.7 0 32 -14.3 32 -32 V 224 c 0 -17.7 -14.3 -32 -32 -32 Z M 350 856.2 L 263.9 770 H 350 v 86.2 Z M 664 888 H 414 V 746 c 0 -22.1 -17.9 -40 -40 -40 H 232 V 264 h 432 v 624 Z" /></svg></i></button><pre class="line-numbers  language-java"><code class="java  language-java"><span class="token number">7409</span>      <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">sendAccessibilityEventInternal</span><span class="token punctuation">(</span><span class="token keyword">int</span> eventType<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">7410</span>          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">AccessibilityManager</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span>mContext<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">7411</span>              <span class="token function">sendAccessibilityEventUnchecked</span><span class="token punctuation">(</span><span class="token class-name">AccessibilityEvent</span><span class="token punctuation">.</span><span class="token function">obtain</span><span class="token punctuation">(</span>eventType<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">7412</span>          <span class="token punctuation">}</span>
<span class="token number">7413</span>      <span class="token punctuation">}</span>
<span class="line-numbers-rows" aria-hidden="true"><span></span><span></span><span></span><span></span><span></span></span></code></pre></div>
<p>在<code>sendAccessibilityEventUnchecked()</code>中又会调用<code>sendAccessibilityEventUncheckedInternal()</code>。</p>
<p><em>View.java -- sendAccessibilityEventUnchecked()</em></p>
<div class="_2Uzcx_"><button class="VJbwyy" aria-label="复制代码" type="button"><i class="anticon anticon-copy" aria-label="icon: copy"><svg xmlns="http://www.w3.org/2000/svg" class="" aria-hidden="true" fill="currentColor" viewBox="64 64 896 896" focusable="false" width="1em" height="1em" data-icon="copy"><path d="M 832 64 H 296 c -4.4 0 -8 3.6 -8 8 v 56 c 0 4.4 3.6 8 8 8 h 496 v 688 c 0 4.4 3.6 8 8 8 h 56 c 4.4 0 8 -3.6 8 -8 V 96 c 0 -17.7 -14.3 -32 -32 -32 Z M 704 192 H 192 c -17.7 0 -32 14.3 -32 32 v 530.7 c 0 8.5 3.4 16.6 9.4 22.6 l 173.3 173.3 c 2.2 2.2 4.7 4 7.4 5.5 v 1.9 h 4.2 c 3.5 1.3 7.2 2 11 2 H 704 c 17.7 0 32 -14.3 32 -32 V 224 c 0 -17.7 -14.3 -32 -32 -32 Z M 350 856.2 L 263.9 770 H 350 v 86.2 Z M 664 888 H 414 V 746 c 0 -22.1 -17.9 -40 -40 -40 H 232 V 264 h 432 v 624 Z" /></svg></i></button><pre class="line-numbers  language-java"><code class="java  language-java"><span class="token number">7430</span>      <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">sendAccessibilityEventUnchecked</span><span class="token punctuation">(</span><span class="token class-name">AccessibilityEvent</span> event<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">7431</span>          <span class="token keyword">if</span> <span class="token punctuation">(</span>mAccessibilityDelegate <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">7432</span>              mAccessibilityDelegate<span class="token punctuation">.</span><span class="token function">sendAccessibilityEventUnchecked</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> event<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">7433</span>          <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
<span class="token number">7434</span>              <span class="token function">sendAccessibilityEventUncheckedInternal</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">7435</span>          <span class="token punctuation">}</span>
<span class="token number">7436</span>      <span class="token punctuation">}</span>
<span class="line-numbers-rows" aria-hidden="true"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div>
<p>在<code>sendAccessibilityEventUncheckedInternal()</code>中，会调用<code>onInitializeAccessibilityEvent()</code>初始化一些event信息，比如className/packageName/source等，然后会调用<code>getParent().requestSendAccessibilityEvent(this, event)</code>将event分发给ParentView。</p>
<p><em>View.java -- sendAccessibilityEventUncheckedInternal()</em></p>
<div class="_2Uzcx_"><button class="VJbwyy" aria-label="复制代码" type="button"><i class="anticon anticon-copy" aria-label="icon: copy"><svg xmlns="http://www.w3.org/2000/svg" class="" aria-hidden="true" fill="currentColor" viewBox="64 64 896 896" focusable="false" width="1em" height="1em" data-icon="copy"><path d="M 832 64 H 296 c -4.4 0 -8 3.6 -8 8 v 56 c 0 4.4 3.6 8 8 8 h 496 v 688 c 0 4.4 3.6 8 8 8 h 56 c 4.4 0 8 -3.6 8 -8 V 96 c 0 -17.7 -14.3 -32 -32 -32 Z M 704 192 H 192 c -17.7 0 -32 14.3 -32 32 v 530.7 c 0 8.5 3.4 16.6 9.4 22.6 l 173.3 173.3 c 2.2 2.2 4.7 4 7.4 5.5 v 1.9 h 4.2 c 3.5 1.3 7.2 2 11 2 H 704 c 17.7 0 32 -14.3 32 -32 V 224 c 0 -17.7 -14.3 -32 -32 -32 Z M 350 856.2 L 263.9 770 H 350 v 86.2 Z M 664 888 H 414 V 746 c 0 -22.1 -17.9 -40 -40 -40 H 232 V 264 h 432 v 624 Z" /></svg></i></button><pre class="line-numbers  language-java"><code class="java  language-java"><span class="token number">7445</span>      <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">sendAccessibilityEventUncheckedInternal</span><span class="token punctuation">(</span><span class="token class-name">AccessibilityEvent</span> event<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">7446</span>          <span class="token comment">// Panes disappearing are relevant even if though the view is no longer visible.</span>
<span class="token number">7447</span>          <span class="token keyword">boolean</span> isWindowStateChanged <span class="token operator">=</span>
<span class="token number">7448</span>                  <span class="token punctuation">(</span>event<span class="token punctuation">.</span><span class="token function">getEventType</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token class-name">AccessibilityEvent</span><span class="token punctuation">.</span>TYPE_WINDOW_STATE_CHANGED<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">7449</span>          <span class="token keyword">boolean</span> isWindowDisappearedEvent <span class="token operator">=</span> isWindowStateChanged <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span><span class="token function">getContentChangeTypes</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token number">7450</span>                  <span class="token operator">&amp;</span> <span class="token class-name">AccessibilityEvent</span><span class="token punctuation">.</span>CONTENT_CHANGE_TYPE_PANE_DISAPPEARED<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">7451</span>          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isShown</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>isWindowDisappearedEvent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">7452</span>              <span class="token keyword">return</span><span class="token punctuation">;</span>
<span class="token number">7453</span>          <span class="token punctuation">}</span>
<span class="token number">7454</span>          <span class="token function">onInitializeAccessibilityEvent</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">7455</span>          <span class="token comment">// Only a subset of accessibility events populates text content.</span>
<span class="token number">7456</span>          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span><span class="token function">getEventType</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> POPULATING_ACCESSIBILITY_EVENT_TYPES<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">7457</span>              <span class="token function">dispatchPopulateAccessibilityEvent</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">7458</span>          <span class="token punctuation">}</span>
<span class="token number">7459</span>          <span class="token comment">// In the beginning we called #isShown(), so we know that getParent() is not null.</span>
<span class="token number">7460</span>          <span class="token class-name">ViewParent</span> parent <span class="token operator">=</span> <span class="token function">getParent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">7461</span>          <span class="token keyword">if</span> <span class="token punctuation">(</span>parent <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">7462</span>              <span class="token function">getParent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">requestSendAccessibilityEvent</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> event<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">7463</span>          <span class="token punctuation">}</span>
<span class="token number">7464</span>      <span class="token punctuation">}</span>
<span class="line-numbers-rows" aria-hidden="true"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div>
<p>这里不管ParentView是哪一个，最终会到View层次中的顶层，也就是ViewRootImpl的<code>requestSendAccessibilityEvent()</code>。这里，会对一些特殊Type的AccessibilityEvent做特殊处理，最终是调用到<code>mAccessibilityManager.sendAccessibilityEvent(event)</code>，也就是到了AM。</p>
<p><em>ViewRootImpl.java -- requestSendAccessibilityEvent()</em></p>
<div class="_2Uzcx_"><button class="VJbwyy" aria-label="复制代码" type="button"><i class="anticon anticon-copy" aria-label="icon: copy"><svg xmlns="http://www.w3.org/2000/svg" class="" aria-hidden="true" fill="currentColor" viewBox="64 64 896 896" focusable="false" width="1em" height="1em" data-icon="copy"><path d="M 832 64 H 296 c -4.4 0 -8 3.6 -8 8 v 56 c 0 4.4 3.6 8 8 8 h 496 v 688 c 0 4.4 3.6 8 8 8 h 56 c 4.4 0 8 -3.6 8 -8 V 96 c 0 -17.7 -14.3 -32 -32 -32 Z M 704 192 H 192 c -17.7 0 -32 14.3 -32 32 v 530.7 c 0 8.5 3.4 16.6 9.4 22.6 l 173.3 173.3 c 2.2 2.2 4.7 4 7.4 5.5 v 1.9 h 4.2 c 3.5 1.3 7.2 2 11 2 H 704 c 17.7 0 32 -14.3 32 -32 V 224 c 0 -17.7 -14.3 -32 -32 -32 Z M 350 856.2 L 263.9 770 H 350 v 86.2 Z M 664 888 H 414 V 746 c 0 -22.1 -17.9 -40 -40 -40 H 232 V 264 h 432 v 624 Z" /></svg></i></button><pre class="line-numbers  language-java"><code class="java  language-java"><span class="token number">7788</span>      <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">requestSendAccessibilityEvent</span><span class="token punctuation">(</span><span class="token class-name">View</span> child<span class="token punctuation">,</span> <span class="token class-name">AccessibilityEvent</span> event<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">7789</span>          <span class="token keyword">if</span> <span class="token punctuation">(</span>mView <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> mStopped <span class="token operator">||</span> mPausedForTransition<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">7790</span>              <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token number">7791</span>          <span class="token punctuation">}</span>
<span class="token number">7792</span>  
<span class="token number">7793</span>          <span class="token comment">// Immediately flush pending content changed event (if any) to preserve event order</span>
<span class="token number">7794</span>          <span class="token keyword">if</span> <span class="token punctuation">(</span>event<span class="token punctuation">.</span><span class="token function">getEventType</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token class-name">AccessibilityEvent</span><span class="token punctuation">.</span>TYPE_WINDOW_CONTENT_CHANGED
<span class="token number">7795</span>                  <span class="token operator">&amp;&amp;</span> mSendWindowContentChangedAccessibilityEvent <span class="token operator">!=</span> <span class="token keyword">null</span>
<span class="token number">7796</span>                  <span class="token operator">&amp;&amp;</span> mSendWindowContentChangedAccessibilityEvent<span class="token punctuation">.</span>mSource <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">7797</span>              mSendWindowContentChangedAccessibilityEvent<span class="token punctuation">.</span><span class="token function">removeCallbacksAndRun</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">7798</span>          <span class="token punctuation">}</span>
<span class="token number">7799</span>  
<span class="token number">7800</span>          <span class="token comment">// Intercept accessibility focus events fired by virtual nodes to keep</span>
<span class="token number">7801</span>          <span class="token comment">// track of accessibility focus position in such nodes.</span>
<span class="token number">7802</span>          <span class="token keyword">final</span> <span class="token keyword">int</span> eventType <span class="token operator">=</span> event<span class="token punctuation">.</span><span class="token function">getEventType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">7803</span>          <span class="token keyword">switch</span> <span class="token punctuation">(</span>eventType<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">7804</span>              <span class="token keyword">case</span> <span class="token class-name">AccessibilityEvent</span><span class="token punctuation">.</span>TYPE_VIEW_ACCESSIBILITY_FOCUSED<span class="token operator">:</span> <span class="token punctuation">{</span>
<span class="token number">7805</span>                  <span class="token keyword">final</span> <span class="token keyword">long</span> sourceNodeId <span class="token operator">=</span> event<span class="token punctuation">.</span><span class="token function">getSourceNodeId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">7806</span>                  <span class="token keyword">final</span> <span class="token keyword">int</span> accessibilityViewId <span class="token operator">=</span> <span class="token class-name">AccessibilityNodeInfo</span><span class="token punctuation">.</span><span class="token function">getAccessibilityViewId</span><span class="token punctuation">(</span>
<span class="token number">7807</span>                          sourceNodeId<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">7808</span>                  <span class="token class-name">View</span> source <span class="token operator">=</span> mView<span class="token punctuation">.</span><span class="token function">findViewByAccessibilityId</span><span class="token punctuation">(</span>accessibilityViewId<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">7809</span>                  <span class="token keyword">if</span> <span class="token punctuation">(</span>source <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">7810</span>                      <span class="token class-name">AccessibilityNodeProvider</span> provider <span class="token operator">=</span> source<span class="token punctuation">.</span><span class="token function">getAccessibilityNodeProvider</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">7811</span>                      <span class="token keyword">if</span> <span class="token punctuation">(</span>provider <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">7812</span>                          <span class="token keyword">final</span> <span class="token keyword">int</span> virtualNodeId <span class="token operator">=</span> <span class="token class-name">AccessibilityNodeInfo</span><span class="token punctuation">.</span><span class="token function">getVirtualDescendantId</span><span class="token punctuation">(</span>
<span class="token number">7813</span>                                  sourceNodeId<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">7814</span>                          <span class="token keyword">final</span> <span class="token class-name">AccessibilityNodeInfo</span> node<span class="token punctuation">;</span>
<span class="token number">7815</span>                          node <span class="token operator">=</span> provider<span class="token punctuation">.</span><span class="token function">createAccessibilityNodeInfo</span><span class="token punctuation">(</span>virtualNodeId<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">7816</span>                          <span class="token function">setAccessibilityFocus</span><span class="token punctuation">(</span>source<span class="token punctuation">,</span> node<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">7817</span>                      <span class="token punctuation">}</span>
<span class="token number">7818</span>                  <span class="token punctuation">}</span>
<span class="token number">7819</span>              <span class="token punctuation">}</span> <span class="token keyword">break</span><span class="token punctuation">;</span>
<span class="token number">7820</span>              <span class="token keyword">case</span> <span class="token class-name">AccessibilityEvent</span><span class="token punctuation">.</span>TYPE_VIEW_ACCESSIBILITY_FOCUS_CLEARED<span class="token operator">:</span> <span class="token punctuation">{</span>
<span class="token number">7821</span>                  <span class="token keyword">final</span> <span class="token keyword">long</span> sourceNodeId <span class="token operator">=</span> event<span class="token punctuation">.</span><span class="token function">getSourceNodeId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">7822</span>                  <span class="token keyword">final</span> <span class="token keyword">int</span> accessibilityViewId <span class="token operator">=</span> <span class="token class-name">AccessibilityNodeInfo</span><span class="token punctuation">.</span><span class="token function">getAccessibilityViewId</span><span class="token punctuation">(</span>
<span class="token number">7823</span>                          sourceNodeId<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">7824</span>                  <span class="token class-name">View</span> source <span class="token operator">=</span> mView<span class="token punctuation">.</span><span class="token function">findViewByAccessibilityId</span><span class="token punctuation">(</span>accessibilityViewId<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">7825</span>                  <span class="token keyword">if</span> <span class="token punctuation">(</span>source <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">7826</span>                      <span class="token class-name">AccessibilityNodeProvider</span> provider <span class="token operator">=</span> source<span class="token punctuation">.</span><span class="token function">getAccessibilityNodeProvider</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">7827</span>                      <span class="token keyword">if</span> <span class="token punctuation">(</span>provider <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">7828</span>                          <span class="token function">setAccessibilityFocus</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">7829</span>                      <span class="token punctuation">}</span>
<span class="token number">7830</span>                  <span class="token punctuation">}</span>
<span class="token number">7831</span>              <span class="token punctuation">}</span> <span class="token keyword">break</span><span class="token punctuation">;</span>
<span class="token number">7832</span>  
<span class="token number">7833</span>  
<span class="token number">7834</span>              <span class="token keyword">case</span> <span class="token class-name">AccessibilityEvent</span><span class="token punctuation">.</span>TYPE_WINDOW_CONTENT_CHANGED<span class="token operator">:</span> <span class="token punctuation">{</span>
<span class="token number">7835</span>                  <span class="token function">handleWindowContentChangedEvent</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">7836</span>              <span class="token punctuation">}</span> <span class="token keyword">break</span><span class="token punctuation">;</span>
<span class="token number">7837</span>          <span class="token punctuation">}</span>
<span class="token number">7838</span>          mAccessibilityManager<span class="token punctuation">.</span><span class="token function">sendAccessibilityEvent</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">7839</span>          <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token number">7840</span>      <span class="token punctuation">}</span>
<span class="line-numbers-rows" aria-hidden="true"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div>
<p>在AM和AMS的联系一节中讲到，AM会用AMS的本地Binder<code>IAccessibilityManager</code>去和AMS通信，在AM的<code>sendAccessibilityEvent()</code>可以看到定义了一个<code>IAccessibilityManager</code>类型的service，通过<code>getServiceLocked()</code>获取本地Binder，然后通过<code>service.sendAccessibilityEvent(dispatchedEvent, userId)</code>去调用AMS的sendAccessibilityEvent方法。到这里Trigger的部分就结束了，然后是AMS的分发过程。</p>
<p><em>AccessibilityManager.java -- sendAccessibilityEvent()</em></p>
<div class="_2Uzcx_"><button class="VJbwyy" aria-label="复制代码" type="button"><i class="anticon anticon-copy" aria-label="icon: copy"><svg xmlns="http://www.w3.org/2000/svg" class="" aria-hidden="true" fill="currentColor" viewBox="64 64 896 896" focusable="false" width="1em" height="1em" data-icon="copy"><path d="M 832 64 H 296 c -4.4 0 -8 3.6 -8 8 v 56 c 0 4.4 3.6 8 8 8 h 496 v 688 c 0 4.4 3.6 8 8 8 h 56 c 4.4 0 8 -3.6 8 -8 V 96 c 0 -17.7 -14.3 -32 -32 -32 Z M 704 192 H 192 c -17.7 0 -32 14.3 -32 32 v 530.7 c 0 8.5 3.4 16.6 9.4 22.6 l 173.3 173.3 c 2.2 2.2 4.7 4 7.4 5.5 v 1.9 h 4.2 c 3.5 1.3 7.2 2 11 2 H 704 c 17.7 0 32 -14.3 32 -32 V 224 c 0 -17.7 -14.3 -32 -32 -32 Z M 350 856.2 L 263.9 770 H 350 v 86.2 Z M 664 888 H 414 V 746 c 0 -22.1 -17.9 -40 -40 -40 H 232 V 264 h 432 v 624 Z" /></svg></i></button><pre class="line-numbers  language-java"><code class="java  language-java"><span class="token number">456</span>      <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">sendAccessibilityEvent</span><span class="token punctuation">(</span><span class="token class-name">AccessibilityEvent</span> event<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">457</span>          <span class="token keyword">final</span> <span class="token class-name">IAccessibilityManager</span> service<span class="token punctuation">;</span>
<span class="token number">458</span>          <span class="token keyword">final</span> <span class="token keyword">int</span> userId<span class="token punctuation">;</span>
<span class="token number">459</span>          <span class="token keyword">final</span> <span class="token class-name">AccessibilityEvent</span> dispatchedEvent<span class="token punctuation">;</span>
<span class="token number">460</span>          <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>mLock<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">461</span>              service <span class="token operator">=</span> <span class="token function">getServiceLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">462</span>              <span class="token keyword">if</span> <span class="token punctuation">(</span>service <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">463</span>                  <span class="token keyword">return</span><span class="token punctuation">;</span>
<span class="token number">464</span>              <span class="token punctuation">}</span>
<span class="token number">465</span>              event<span class="token punctuation">.</span><span class="token function">setEventTime</span><span class="token punctuation">(</span><span class="token class-name">SystemClock</span><span class="token punctuation">.</span><span class="token function">uptimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">466</span>              <span class="token keyword">if</span> <span class="token punctuation">(</span>mAccessibilityPolicy <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">467</span>                  dispatchedEvent <span class="token operator">=</span> mAccessibilityPolicy<span class="token punctuation">.</span><span class="token function">onAccessibilityEvent</span><span class="token punctuation">(</span>event<span class="token punctuation">,</span>
<span class="token number">468</span>                          mIsEnabled<span class="token punctuation">,</span> mRelevantEventTypes<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">469</span>                  <span class="token keyword">if</span> <span class="token punctuation">(</span>dispatchedEvent <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">470</span>                      <span class="token keyword">return</span><span class="token punctuation">;</span>
<span class="token number">471</span>                  <span class="token punctuation">}</span>
<span class="token number">472</span>              <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
<span class="token number">473</span>                  dispatchedEvent <span class="token operator">=</span> event<span class="token punctuation">;</span>
<span class="token number">474</span>              <span class="token punctuation">}</span>
<span class="token number">475</span>              <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">476</span>                  <span class="token class-name">Looper</span> myLooper <span class="token operator">=</span> <span class="token class-name">Looper</span><span class="token punctuation">.</span><span class="token function">myLooper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">477</span>                  <span class="token keyword">if</span> <span class="token punctuation">(</span>myLooper <span class="token operator">==</span> <span class="token class-name">Looper</span><span class="token punctuation">.</span><span class="token function">getMainLooper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">478</span>                      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span>
<span class="token number">479</span>                              <span class="token string">"Accessibility off. Did you forget to check that?"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">480</span>                  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
<span class="token number">481</span>                      <span class="token comment">// If we're not running on the thread with the main looper, it's possible for</span>
<span class="token number">482</span>                      <span class="token comment">// the state of accessibility to change between checking isEnabled and</span>
<span class="token number">483</span>                      <span class="token comment">// calling this method. So just log the error rather than throwing the</span>
<span class="token number">484</span>                      <span class="token comment">// exception.</span>
<span class="token number">485</span>                      <span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span>LOG_TAG<span class="token punctuation">,</span> <span class="token string">"AccessibilityEvent sent with accessibility disabled"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">486</span>                      <span class="token keyword">return</span><span class="token punctuation">;</span>
<span class="token number">487</span>                  <span class="token punctuation">}</span>
<span class="token number">488</span>              <span class="token punctuation">}</span>
<span class="token number">489</span>              <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>dispatchedEvent<span class="token punctuation">.</span><span class="token function">getEventType</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> mRelevantEventTypes<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">490</span>                  <span class="token keyword">if</span> <span class="token punctuation">(</span>DEBUG<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">491</span>                      <span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">i</span><span class="token punctuation">(</span>LOG_TAG<span class="token punctuation">,</span> <span class="token string">"Not dispatching irrelevant event: "</span> <span class="token operator">+</span> dispatchedEvent
<span class="token number">492</span>                              <span class="token operator">+</span> <span class="token string">" that is not among "</span>
<span class="token number">493</span>                              <span class="token operator">+</span> <span class="token class-name">AccessibilityEvent</span><span class="token punctuation">.</span><span class="token function">eventTypeToString</span><span class="token punctuation">(</span>mRelevantEventTypes<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">494</span>                  <span class="token punctuation">}</span>
<span class="token number">495</span>                  <span class="token keyword">return</span><span class="token punctuation">;</span>
<span class="token number">496</span>              <span class="token punctuation">}</span>
<span class="token number">497</span>              userId <span class="token operator">=</span> mUserId<span class="token punctuation">;</span>
<span class="token number">498</span>          <span class="token punctuation">}</span>
<span class="token number">499</span>          <span class="token keyword">try</span> <span class="token punctuation">{</span>
<span class="token number">500</span>              <span class="token comment">// it is possible that this manager is in the same process as the service but</span>
<span class="token number">501</span>              <span class="token comment">// client using it is called through Binder from another process. Example: MMS</span>
<span class="token number">502</span>              <span class="token comment">// app adds a SMS notification and the NotificationManagerService calls this method</span>
<span class="token number">503</span>              <span class="token keyword">long</span> identityToken <span class="token operator">=</span> <span class="token class-name">Binder</span><span class="token punctuation">.</span><span class="token function">clearCallingIdentity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">504</span>              <span class="token keyword">try</span> <span class="token punctuation">{</span>
<span class="token number">505</span>                  service<span class="token punctuation">.</span><span class="token function">sendAccessibilityEvent</span><span class="token punctuation">(</span>dispatchedEvent<span class="token punctuation">,</span> userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">506</span>              <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
<span class="token number">507</span>                  <span class="token class-name">Binder</span><span class="token punctuation">.</span><span class="token function">restoreCallingIdentity</span><span class="token punctuation">(</span>identityToken<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">508</span>              <span class="token punctuation">}</span>
<span class="token number">509</span>              <span class="token keyword">if</span> <span class="token punctuation">(</span>DEBUG<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">510</span>                  <span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">i</span><span class="token punctuation">(</span>LOG_TAG<span class="token punctuation">,</span> dispatchedEvent <span class="token operator">+</span> <span class="token string">" sent"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">511</span>              <span class="token punctuation">}</span>
<span class="token number">512</span>          <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RemoteException</span> re<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">513</span>              <span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span>LOG_TAG<span class="token punctuation">,</span> <span class="token string">"Error during sending "</span> <span class="token operator">+</span> dispatchedEvent <span class="token operator">+</span> <span class="token string">" "</span><span class="token punctuation">,</span> re<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">514</span>          <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
<span class="token number">515</span>              <span class="token keyword">if</span> <span class="token punctuation">(</span>event <span class="token operator">!=</span> dispatchedEvent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">516</span>                  event<span class="token punctuation">.</span><span class="token function">recycle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">517</span>              <span class="token punctuation">}</span>
<span class="token number">518</span>              dispatchedEvent<span class="token punctuation">.</span><span class="token function">recycle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">519</span>          <span class="token punctuation">}</span>
<span class="token number">520</span>      <span class="token punctuation">}</span>
<span class="line-numbers-rows" aria-hidden="true"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div>
<h2>AccessibilityEvent Dispatch</h2>
<p>在AMS的<code>sendAccessibilityEvent()</code>中，会调用<code>notifyAccessibilityServicesDelayedLocked()</code>。</p>
<p><em>AccessibilityManagerService.java -- sendAccessibilityEvent()</em></p>
<div class="_2Uzcx_"><button class="VJbwyy" aria-label="复制代码" type="button"><i class="anticon anticon-copy" aria-label="icon: copy"><svg xmlns="http://www.w3.org/2000/svg" class="" aria-hidden="true" fill="currentColor" viewBox="64 64 896 896" focusable="false" width="1em" height="1em" data-icon="copy"><path d="M 832 64 H 296 c -4.4 0 -8 3.6 -8 8 v 56 c 0 4.4 3.6 8 8 8 h 496 v 688 c 0 4.4 3.6 8 8 8 h 56 c 4.4 0 8 -3.6 8 -8 V 96 c 0 -17.7 -14.3 -32 -32 -32 Z M 704 192 H 192 c -17.7 0 -32 14.3 -32 32 v 530.7 c 0 8.5 3.4 16.6 9.4 22.6 l 173.3 173.3 c 2.2 2.2 4.7 4 7.4 5.5 v 1.9 h 4.2 c 3.5 1.3 7.2 2 11 2 H 704 c 17.7 0 32 -14.3 32 -32 V 224 c 0 -17.7 -14.3 -32 -32 -32 Z M 350 856.2 L 263.9 770 H 350 v 86.2 Z M 664 888 H 414 V 746 c 0 -22.1 -17.9 -40 -40 -40 H 232 V 264 h 432 v 624 Z" /></svg></i></button><pre class="line-numbers  language-java"><code class="java  language-java"><span class="token number">519</span>      <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">sendAccessibilityEvent</span><span class="token punctuation">(</span><span class="token class-name">AccessibilityEvent</span> event<span class="token punctuation">,</span> <span class="token keyword">int</span> userId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">520</span>          <span class="token keyword">boolean</span> dispatchEvent <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token number">521</span>  
<span class="token number">522</span>          <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>mLock<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">523</span>              <span class="token keyword">if</span> <span class="token punctuation">(</span>event<span class="token punctuation">.</span><span class="token function">getWindowId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span>
<span class="token number">524</span>                  <span class="token class-name">AccessibilityWindowInfo</span><span class="token punctuation">.</span>PICTURE_IN_PICTURE_ACTION_REPLACER_WINDOW_ID<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">525</span>                  <span class="token comment">// The replacer window isn't shown to services. Move its events into the pip.</span>
<span class="token number">526</span>                  <span class="token class-name">AccessibilityWindowInfo</span> pip <span class="token operator">=</span> mSecurityPolicy<span class="token punctuation">.</span><span class="token function">getPictureInPictureWindow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">527</span>                  <span class="token keyword">if</span> <span class="token punctuation">(</span>pip <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">528</span>                      <span class="token keyword">int</span> pipId <span class="token operator">=</span> pip<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">529</span>                      event<span class="token punctuation">.</span><span class="token function">setWindowId</span><span class="token punctuation">(</span>pipId<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">530</span>                  <span class="token punctuation">}</span>
<span class="token number">531</span>              <span class="token punctuation">}</span>
<span class="token number">532</span>  
<span class="token number">533</span>              <span class="token comment">// We treat calls from a profile as if made by its parent as profiles</span>
<span class="token number">534</span>              <span class="token comment">// share the accessibility state of the parent. The call below</span>
<span class="token number">535</span>              <span class="token comment">// performs the current profile parent resolution.</span>
<span class="token number">536</span>              <span class="token keyword">final</span> <span class="token keyword">int</span> resolvedUserId <span class="token operator">=</span> mSecurityPolicy
<span class="token number">537</span>                      <span class="token punctuation">.</span><span class="token function">resolveCallingUserIdEnforcingPermissionsLocked</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">538</span>  
<span class="token number">539</span>              <span class="token comment">// Make sure the reported package is one the caller has access to.</span>
<span class="token number">540</span>              event<span class="token punctuation">.</span><span class="token function">setPackageName</span><span class="token punctuation">(</span>mSecurityPolicy<span class="token punctuation">.</span><span class="token function">resolveValidReportedPackageLocked</span><span class="token punctuation">(</span>
<span class="token number">541</span>                      event<span class="token punctuation">.</span><span class="token function">getPackageName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">UserHandle</span><span class="token punctuation">.</span><span class="token function">getCallingAppId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> resolvedUserId<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">542</span>  
<span class="token number">543</span>              <span class="token comment">// This method does nothing for a background user.</span>
<span class="token number">544</span>              <span class="token keyword">if</span> <span class="token punctuation">(</span>resolvedUserId <span class="token operator">==</span> mCurrentUserId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">545</span>                  <span class="token keyword">if</span> <span class="token punctuation">(</span>mSecurityPolicy<span class="token punctuation">.</span><span class="token function">canDispatchAccessibilityEventLocked</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">546</span>                      mSecurityPolicy<span class="token punctuation">.</span><span class="token function">updateActiveAndAccessibilityFocusedWindowLocked</span><span class="token punctuation">(</span>
<span class="token number">547</span>                              event<span class="token punctuation">.</span><span class="token function">getWindowId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> event<span class="token punctuation">.</span><span class="token function">getSourceNodeId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token number">548</span>                              event<span class="token punctuation">.</span><span class="token function">getEventType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> event<span class="token punctuation">.</span><span class="token function">getAction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">549</span>                      mSecurityPolicy<span class="token punctuation">.</span><span class="token function">updateEventSourceLocked</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">550</span>                      dispatchEvent <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token number">551</span>                  <span class="token punctuation">}</span>
<span class="token number">552</span>                  <span class="token keyword">if</span> <span class="token punctuation">(</span>mHasInputFilter <span class="token operator">&amp;&amp;</span> mInputFilter <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">553</span>                      mMainHandler<span class="token punctuation">.</span><span class="token function">sendMessage</span><span class="token punctuation">(</span><span class="token function">obtainMessage</span><span class="token punctuation">(</span>
<span class="token number">554</span>                              <span class="token class-name">AccessibilityManagerService</span><span class="token operator">:</span><span class="token operator">:</span><span class="token function">sendAccessibilityEventToInputFilter</span><span class="token punctuation">,</span>
<span class="token number">555</span>                              <span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token class-name">AccessibilityEvent</span><span class="token punctuation">.</span><span class="token function">obtain</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">556</span>                  <span class="token punctuation">}</span>
<span class="token number">557</span>              <span class="token punctuation">}</span>
<span class="token number">558</span>          <span class="token punctuation">}</span>
<span class="token number">559</span>  
<span class="token number">560</span>          <span class="token keyword">if</span> <span class="token punctuation">(</span>dispatchEvent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">561</span>              <span class="token comment">// Make sure clients receiving this event will be able to get the</span>
<span class="token number">562</span>              <span class="token comment">// current state of the windows as the window manager may be delaying</span>
<span class="token number">563</span>              <span class="token comment">// the computation for performance reasons.</span>
<span class="token number">564</span>              <span class="token keyword">if</span> <span class="token punctuation">(</span>event<span class="token punctuation">.</span><span class="token function">getEventType</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token class-name">AccessibilityEvent</span><span class="token punctuation">.</span>TYPE_WINDOW_STATE_CHANGED
<span class="token number">565</span>                      <span class="token operator">&amp;&amp;</span> mWindowsForAccessibilityCallback <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">566</span>                  <span class="token class-name">WindowManagerInternal</span> wm <span class="token operator">=</span> <span class="token class-name">LocalServices</span><span class="token punctuation">.</span><span class="token function">getService</span><span class="token punctuation">(</span><span class="token class-name">WindowManagerInternal</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">567</span>                  wm<span class="token punctuation">.</span><span class="token function">computeWindowsForAccessibility</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">568</span>              <span class="token punctuation">}</span>
<span class="token number">569</span>              <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>mLock<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">570</span>                  <span class="token function">notifyAccessibilityServicesDelayedLocked</span><span class="token punctuation">(</span>event<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">571</span>                  <span class="token function">notifyAccessibilityServicesDelayedLocked</span><span class="token punctuation">(</span>event<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">572</span>                  mUiAutomationManager<span class="token punctuation">.</span><span class="token function">sendAccessibilityEventLocked</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">573</span>              <span class="token punctuation">}</span>
<span class="token number">574</span>          <span class="token punctuation">}</span>
<span class="token number">575</span>  
<span class="token number">576</span>          <span class="token keyword">if</span> <span class="token punctuation">(</span>OWN_PROCESS_ID <span class="token operator">!=</span> <span class="token class-name">Binder</span><span class="token punctuation">.</span><span class="token function">getCallingPid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">577</span>              event<span class="token punctuation">.</span><span class="token function">recycle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">578</span>          <span class="token punctuation">}</span>
<span class="token number">579</span>      <span class="token punctuation">}</span>
<span class="line-numbers-rows" aria-hidden="true"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div>
<p>在<strong>AMS绑定AS</strong>这一节讲到，AMS会维护一个绑定AS的List（<code>mBoundServices</code>），List中每一个AccessibilityServiceConnection对应一个绑定的AS，因此遍历mBoundServices，然后去到AccessibilityServiceConnection的<code>notifyAccessibilityEvent()</code>函数。</p>
<p><em>AccessibilityManagerService.java -- notifyAccessibilityServicesDelayedLocked()</em></p>
<div class="_2Uzcx_"><button class="VJbwyy" aria-label="复制代码" type="button"><i class="anticon anticon-copy" aria-label="icon: copy"><svg xmlns="http://www.w3.org/2000/svg" class="" aria-hidden="true" fill="currentColor" viewBox="64 64 896 896" focusable="false" width="1em" height="1em" data-icon="copy"><path d="M 832 64 H 296 c -4.4 0 -8 3.6 -8 8 v 56 c 0 4.4 3.6 8 8 8 h 496 v 688 c 0 4.4 3.6 8 8 8 h 56 c 4.4 0 8 -3.6 8 -8 V 96 c 0 -17.7 -14.3 -32 -32 -32 Z M 704 192 H 192 c -17.7 0 -32 14.3 -32 32 v 530.7 c 0 8.5 3.4 16.6 9.4 22.6 l 173.3 173.3 c 2.2 2.2 4.7 4 7.4 5.5 v 1.9 h 4.2 c 3.5 1.3 7.2 2 11 2 H 704 c 17.7 0 32 -14.3 32 -32 V 224 c 0 -17.7 -14.3 -32 -32 -32 Z M 350 856.2 L 263.9 770 H 350 v 86.2 Z M 664 888 H 414 V 746 c 0 -22.1 -17.9 -40 -40 -40 H 232 V 264 h 432 v 624 Z" /></svg></i></button><pre class="line-numbers  language-java"><code class="java  language-java"><span class="token number">1378</span>      <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">notifyAccessibilityServicesDelayedLocked</span><span class="token punctuation">(</span><span class="token class-name">AccessibilityEvent</span> event<span class="token punctuation">,</span>
<span class="token number">1379</span>              <span class="token keyword">boolean</span> isDefault<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">1380</span>          <span class="token keyword">try</span> <span class="token punctuation">{</span>
<span class="token number">1381</span>              <span class="token class-name">UserState</span> state <span class="token operator">=</span> <span class="token function">getCurrentUserStateLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">1382</span>              <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> count <span class="token operator">=</span> state<span class="token punctuation">.</span>mBoundServices<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> count<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">1383</span>                  <span class="token class-name">AccessibilityServiceConnection</span> service <span class="token operator">=</span> state<span class="token punctuation">.</span>mBoundServices<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">1384</span>  
<span class="token number">1385</span>                  <span class="token keyword">if</span> <span class="token punctuation">(</span>service<span class="token punctuation">.</span>mIsDefault <span class="token operator">==</span> isDefault<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">1386</span>                      service<span class="token punctuation">.</span><span class="token function">notifyAccessibilityEvent</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">1387</span>                  <span class="token punctuation">}</span>
<span class="token number">1388</span>              <span class="token punctuation">}</span>
<span class="token number">1389</span>          <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IndexOutOfBoundsException</span> oobe<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">1390</span>              <span class="token comment">// An out of bounds exception can happen if services are going away</span>
<span class="token number">1391</span>              <span class="token comment">// as the for loop is running. If that happens, just bail because</span>
<span class="token number">1392</span>              <span class="token comment">// there are no more services to notify.</span>
<span class="token number">1393</span>          <span class="token punctuation">}</span>
<span class="token number">1394</span>      <span class="token punctuation">}</span>
<span class="line-numbers-rows" aria-hidden="true"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div>
<p>AccessibilityServiceConnection是继承AbstractAccessibilityServiceConnection的，这里<code>notifyAccessibilityEvent()</code>会发送一个message。</p>
<p><em>AbstractAccessibilityServiceConnection.java -- notifyAccessibilityEvent()</em></p>
<div class="_2Uzcx_"><button class="VJbwyy" aria-label="复制代码" type="button"><i class="anticon anticon-copy" aria-label="icon: copy"><svg xmlns="http://www.w3.org/2000/svg" class="" aria-hidden="true" fill="currentColor" viewBox="64 64 896 896" focusable="false" width="1em" height="1em" data-icon="copy"><path d="M 832 64 H 296 c -4.4 0 -8 3.6 -8 8 v 56 c 0 4.4 3.6 8 8 8 h 496 v 688 c 0 4.4 3.6 8 8 8 h 56 c 4.4 0 8 -3.6 8 -8 V 96 c 0 -17.7 -14.3 -32 -32 -32 Z M 704 192 H 192 c -17.7 0 -32 14.3 -32 32 v 530.7 c 0 8.5 3.4 16.6 9.4 22.6 l 173.3 173.3 c 2.2 2.2 4.7 4 7.4 5.5 v 1.9 h 4.2 c 3.5 1.3 7.2 2 11 2 H 704 c 17.7 0 32 -14.3 32 -32 V 224 c 0 -17.7 -14.3 -32 -32 -32 Z M 350 856.2 L 263.9 770 H 350 v 86.2 Z M 664 888 H 414 V 746 c 0 -22.1 -17.9 -40 -40 -40 H 232 V 264 h 432 v 624 Z" /></svg></i></button><pre class="line-numbers  language-java"><code class="java  language-java"><span class="token number">967</span>      <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">notifyAccessibilityEvent</span><span class="token punctuation">(</span><span class="token class-name">AccessibilityEvent</span> event<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">968</span>          <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>mLock<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">969</span>              <span class="token keyword">final</span> <span class="token keyword">int</span> eventType <span class="token operator">=</span> event<span class="token punctuation">.</span><span class="token function">getEventType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">970</span>  
<span class="token number">971</span>              <span class="token keyword">final</span> <span class="token keyword">boolean</span> serviceWantsEvent <span class="token operator">=</span> <span class="token function">wantsEventLocked</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">972</span>              <span class="token keyword">final</span> <span class="token keyword">boolean</span> requiredForCacheConsistency <span class="token operator">=</span> mUsesAccessibilityCache
<span class="token number">973</span>                      <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">AccessibilityCache</span><span class="token punctuation">.</span>CACHE_CRITICAL_EVENTS_MASK <span class="token operator">&amp;</span> eventType<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">974</span>              <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>serviceWantsEvent <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>requiredForCacheConsistency<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">975</span>                  <span class="token keyword">return</span><span class="token punctuation">;</span>
<span class="token number">976</span>              <span class="token punctuation">}</span>
<span class="token number">977</span>  
<span class="token number">978</span>              <span class="token comment">// Make a copy since during dispatch it is possible the event to</span>
<span class="token number">979</span>              <span class="token comment">// be modified to remove its source if the receiving service does</span>
<span class="token number">980</span>              <span class="token comment">// not have permission to access the window content.</span>
<span class="token number">981</span>              <span class="token class-name">AccessibilityEvent</span> newEvent <span class="token operator">=</span> <span class="token class-name">AccessibilityEvent</span><span class="token punctuation">.</span><span class="token function">obtain</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">982</span>              <span class="token class-name">Message</span> message<span class="token punctuation">;</span>
<span class="token number">983</span>              <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>mNotificationTimeout <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
<span class="token number">984</span>                      <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>eventType <span class="token operator">!=</span> <span class="token class-name">AccessibilityEvent</span><span class="token punctuation">.</span>TYPE_WINDOW_CONTENT_CHANGED<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">985</span>                  <span class="token comment">// Allow at most one pending event</span>
<span class="token number">986</span>                  <span class="token keyword">final</span> <span class="token class-name">AccessibilityEvent</span> oldEvent <span class="token operator">=</span> mPendingEvents<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>eventType<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">987</span>                  mPendingEvents<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>eventType<span class="token punctuation">,</span> newEvent<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">988</span>                  <span class="token keyword">if</span> <span class="token punctuation">(</span>oldEvent <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">989</span>                      mEventDispatchHandler<span class="token punctuation">.</span><span class="token function">removeMessages</span><span class="token punctuation">(</span>eventType<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">990</span>                      oldEvent<span class="token punctuation">.</span><span class="token function">recycle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">991</span>                  <span class="token punctuation">}</span>
<span class="token number">992</span>                  message <span class="token operator">=</span> mEventDispatchHandler<span class="token punctuation">.</span><span class="token function">obtainMessage</span><span class="token punctuation">(</span>eventType<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">993</span>              <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
<span class="token number">994</span>                  <span class="token comment">// Send all messages, bypassing mPendingEvents</span>
<span class="token number">995</span>                  message <span class="token operator">=</span> mEventDispatchHandler<span class="token punctuation">.</span><span class="token function">obtainMessage</span><span class="token punctuation">(</span>eventType<span class="token punctuation">,</span> newEvent<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">996</span>              <span class="token punctuation">}</span>
<span class="token number">997</span>              message<span class="token punctuation">.</span>arg1 <span class="token operator">=</span> serviceWantsEvent <span class="token operator">?</span> <span class="token number">1</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token number">998</span>  
<span class="token number">999</span>              mEventDispatchHandler<span class="token punctuation">.</span><span class="token function">sendMessageDelayed</span><span class="token punctuation">(</span>message<span class="token punctuation">,</span> mNotificationTimeout<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">1000</span>          <span class="token punctuation">}</span>
<span class="token number">1001</span>      <span class="token punctuation">}</span>
<span class="line-numbers-rows" aria-hidden="true"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div>
<p>在AbstractAccessibilityServiceConnection的构造函数中，有对消息的处理，它最终会调用<code>notifyAccessibilityEventInternal()</code>。</p>
<p><em>AbstractAccessibilityServiceConnection.java -- AbstractAccessibilityServiceConnection()</em></p>
<div class="_2Uzcx_"><button class="VJbwyy" aria-label="复制代码" type="button"><i class="anticon anticon-copy" aria-label="icon: copy"><svg xmlns="http://www.w3.org/2000/svg" class="" aria-hidden="true" fill="currentColor" viewBox="64 64 896 896" focusable="false" width="1em" height="1em" data-icon="copy"><path d="M 832 64 H 296 c -4.4 0 -8 3.6 -8 8 v 56 c 0 4.4 3.6 8 8 8 h 496 v 688 c 0 4.4 3.6 8 8 8 h 56 c 4.4 0 8 -3.6 8 -8 V 96 c 0 -17.7 -14.3 -32 -32 -32 Z M 704 192 H 192 c -17.7 0 -32 14.3 -32 32 v 530.7 c 0 8.5 3.4 16.6 9.4 22.6 l 173.3 173.3 c 2.2 2.2 4.7 4 7.4 5.5 v 1.9 h 4.2 c 3.5 1.3 7.2 2 11 2 H 704 c 17.7 0 32 -14.3 32 -32 V 224 c 0 -17.7 -14.3 -32 -32 -32 Z M 350 856.2 L 263.9 770 H 350 v 86.2 Z M 664 888 H 414 V 746 c 0 -22.1 -17.9 -40 -40 -40 H 232 V 264 h 432 v 624 Z" /></svg></i></button><pre class="line-numbers  language-java"><code class="java  language-java"><span class="token number">241</span>      <span class="token keyword">public</span> <span class="token class-name">AbstractAccessibilityServiceConnection</span><span class="token punctuation">(</span><span class="token class-name">Context</span> context<span class="token punctuation">,</span> <span class="token class-name">ComponentName</span> componentName<span class="token punctuation">,</span>
<span class="token number">242</span>              <span class="token class-name">AccessibilityServiceInfo</span> accessibilityServiceInfo<span class="token punctuation">,</span> <span class="token keyword">int</span> id<span class="token punctuation">,</span> <span class="token class-name">Handler</span> mainHandler<span class="token punctuation">,</span>
<span class="token number">243</span>              <span class="token class-name">Object</span> lock<span class="token punctuation">,</span> <span class="token class-name">SecurityPolicy</span> securityPolicy<span class="token punctuation">,</span> <span class="token class-name">SystemSupport</span> systemSupport<span class="token punctuation">,</span>
<span class="token number">244</span>              <span class="token class-name">WindowManagerInternal</span> windowManagerInternal<span class="token punctuation">,</span>
<span class="token number">245</span>              <span class="token class-name">GlobalActionPerformer</span> globalActionPerfomer<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">246</span>          mContext <span class="token operator">=</span> context<span class="token punctuation">;</span>
<span class="token number">247</span>          mWindowManagerService <span class="token operator">=</span> windowManagerInternal<span class="token punctuation">;</span>
<span class="token number">248</span>          mId <span class="token operator">=</span> id<span class="token punctuation">;</span>
<span class="token number">249</span>          mComponentName <span class="token operator">=</span> componentName<span class="token punctuation">;</span>
<span class="token number">250</span>          mAccessibilityServiceInfo <span class="token operator">=</span> accessibilityServiceInfo<span class="token punctuation">;</span>
<span class="token number">251</span>          mLock <span class="token operator">=</span> lock<span class="token punctuation">;</span>
<span class="token number">252</span>          mSecurityPolicy <span class="token operator">=</span> securityPolicy<span class="token punctuation">;</span>
<span class="token number">253</span>          mGlobalActionPerformer <span class="token operator">=</span> globalActionPerfomer<span class="token punctuation">;</span>
<span class="token number">254</span>          mSystemSupport <span class="token operator">=</span> systemSupport<span class="token punctuation">;</span>
<span class="token number">255</span>          mInvocationHandler <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">InvocationHandler</span><span class="token punctuation">(</span>mainHandler<span class="token punctuation">.</span><span class="token function">getLooper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">256</span>          mEventDispatchHandler <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Handler</span><span class="token punctuation">(</span>mainHandler<span class="token punctuation">.</span><span class="token function">getLooper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">257</span>              <span class="token annotation punctuation">@Override</span>
<span class="token number">258</span>              <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">handleMessage</span><span class="token punctuation">(</span><span class="token class-name">Message</span> message<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">259</span>                  <span class="token keyword">final</span> <span class="token keyword">int</span> eventType <span class="token operator">=</span>  message<span class="token punctuation">.</span>what<span class="token punctuation">;</span>
<span class="token number">260</span>                  <span class="token class-name">AccessibilityEvent</span> event <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">AccessibilityEvent</span><span class="token punctuation">)</span> message<span class="token punctuation">.</span>obj<span class="token punctuation">;</span>
<span class="token number">261</span>                  <span class="token keyword">boolean</span> serviceWantsEvent <span class="token operator">=</span> message<span class="token punctuation">.</span>arg1 <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token number">262</span>                  <span class="token function">notifyAccessibilityEventInternal</span><span class="token punctuation">(</span>eventType<span class="token punctuation">,</span> event<span class="token punctuation">,</span> serviceWantsEvent<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">263</span>              <span class="token punctuation">}</span>
<span class="token number">264</span>          <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token number">265</span>          <span class="token function">setDynamicallyConfigurableProperties</span><span class="token punctuation">(</span>accessibilityServiceInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">266</span>      <span class="token punctuation">}</span>
<span class="line-numbers-rows" aria-hidden="true"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div>
<p>在<code>notifyAccessibilityEventInternal()</code>中，<code>listener</code>是AS的本地Binder（IAccessibilityServiceClient类型），最终是回调到了AS的<code>onAccessibilityEvent()</code>。到这里Dispatch的部分就结束了。</p>
<p><em>AbstractAccessibilityServiceConnection.java -- notifyAccessibilityEventInternal()</em></p>
<div class="_2Uzcx_"><button class="VJbwyy" aria-label="复制代码" type="button"><i class="anticon anticon-copy" aria-label="icon: copy"><svg xmlns="http://www.w3.org/2000/svg" class="" aria-hidden="true" fill="currentColor" viewBox="64 64 896 896" focusable="false" width="1em" height="1em" data-icon="copy"><path d="M 832 64 H 296 c -4.4 0 -8 3.6 -8 8 v 56 c 0 4.4 3.6 8 8 8 h 496 v 688 c 0 4.4 3.6 8 8 8 h 56 c 4.4 0 8 -3.6 8 -8 V 96 c 0 -17.7 -14.3 -32 -32 -32 Z M 704 192 H 192 c -17.7 0 -32 14.3 -32 32 v 530.7 c 0 8.5 3.4 16.6 9.4 22.6 l 173.3 173.3 c 2.2 2.2 4.7 4 7.4 5.5 v 1.9 h 4.2 c 3.5 1.3 7.2 2 11 2 H 704 c 17.7 0 32 -14.3 32 -32 V 224 c 0 -17.7 -14.3 -32 -32 -32 Z M 350 856.2 L 263.9 770 H 350 v 86.2 Z M 664 888 H 414 V 746 c 0 -22.1 -17.9 -40 -40 -40 H 232 V 264 h 432 v 624 Z" /></svg></i></button><pre class="line-numbers  language-java"><code class="java  language-java"><span class="token number">1040</span>      <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">notifyAccessibilityEventInternal</span><span class="token punctuation">(</span>
<span class="token number">1041</span>              <span class="token keyword">int</span> eventType<span class="token punctuation">,</span>
<span class="token number">1042</span>              <span class="token class-name">AccessibilityEvent</span> event<span class="token punctuation">,</span>
<span class="token number">1043</span>              <span class="token keyword">boolean</span> serviceWantsEvent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">1044</span>          <span class="token class-name">IAccessibilityServiceClient</span> listener<span class="token punctuation">;</span>
<span class="token number">1045</span>  
<span class="token number">1046</span>          <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>mLock<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">1047</span>              listener <span class="token operator">=</span> mServiceInterface<span class="token punctuation">;</span>
<span class="token number">1048</span>  
<span class="token number">1049</span>              <span class="token comment">// If the service died/was disabled while the message for dispatching</span>
<span class="token number">1050</span>              <span class="token comment">// the accessibility event was propagating the listener may be null.</span>
<span class="token number">1051</span>              <span class="token keyword">if</span> <span class="token punctuation">(</span>listener <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">1052</span>                  <span class="token keyword">return</span><span class="token punctuation">;</span>
<span class="token number">1053</span>              <span class="token punctuation">}</span>
<span class="token number">1054</span>  
<span class="token number">1055</span>              <span class="token comment">// There are two ways we notify for events, throttled AND non-throttled. If we</span>
<span class="token number">1056</span>              <span class="token comment">// are not throttling, then messages come with events, which we handle with</span>
<span class="token number">1057</span>              <span class="token comment">// minimal fuss.</span>
<span class="token number">1058</span>              <span class="token keyword">if</span> <span class="token punctuation">(</span>event <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">1059</span>                  <span class="token comment">// We are throttling events, so we'll send the event for this type in</span>
<span class="token number">1060</span>                  <span class="token comment">// mPendingEvents as long as it it's null. It can only null due to a race</span>
<span class="token number">1061</span>                  <span class="token comment">// condition:</span>
<span class="token number">1062</span>                  <span class="token comment">//</span>
<span class="token number">1063</span>                  <span class="token comment">//   1) A binder thread calls notifyAccessibilityServiceDelayedLocked</span>
<span class="token number">1064</span>                  <span class="token comment">//      which posts a message for dispatching an event and stores the event</span>
<span class="token number">1065</span>                  <span class="token comment">//      in mPendingEvents.</span>
<span class="token number">1066</span>                  <span class="token comment">//   2) The message is pulled from the queue by the handler on the service</span>
<span class="token number">1067</span>                  <span class="token comment">//      thread and this method is just about to acquire the lock.</span>
<span class="token number">1068</span>                  <span class="token comment">//   3) Another binder thread acquires the lock in notifyAccessibilityEvent</span>
<span class="token number">1069</span>                  <span class="token comment">//   4) notifyAccessibilityEvent recycles the event that this method was about</span>
<span class="token number">1070</span>                  <span class="token comment">//      to process, replaces it with a new one, and posts a second message</span>
<span class="token number">1071</span>                  <span class="token comment">//   5) This method grabs the new event, processes it, and removes it from</span>
<span class="token number">1072</span>                  <span class="token comment">//      mPendingEvents</span>
<span class="token number">1073</span>                  <span class="token comment">//   6) The second message dispatched in (4) arrives, but the event has been</span>
<span class="token number">1074</span>                  <span class="token comment">//      remvoved in (5).</span>
<span class="token number">1075</span>                  event <span class="token operator">=</span> mPendingEvents<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>eventType<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">1076</span>                  <span class="token keyword">if</span> <span class="token punctuation">(</span>event <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">1077</span>                      <span class="token keyword">return</span><span class="token punctuation">;</span>
<span class="token number">1078</span>                  <span class="token punctuation">}</span>
<span class="token number">1079</span>                  mPendingEvents<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>eventType<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">1080</span>              <span class="token punctuation">}</span>
<span class="token number">1081</span>              <span class="token keyword">if</span> <span class="token punctuation">(</span>mSecurityPolicy<span class="token punctuation">.</span><span class="token function">canRetrieveWindowContentLocked</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">1082</span>                  event<span class="token punctuation">.</span><span class="token function">setConnectionId</span><span class="token punctuation">(</span>mId<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">1083</span>              <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
<span class="token number">1084</span>                  event<span class="token punctuation">.</span><span class="token function">setSource</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">View</span><span class="token punctuation">)</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">1085</span>              <span class="token punctuation">}</span>
<span class="token number">1086</span>              event<span class="token punctuation">.</span><span class="token function">setSealed</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">1087</span>          <span class="token punctuation">}</span>
<span class="token number">1088</span>  
<span class="token number">1089</span>          <span class="token keyword">try</span> <span class="token punctuation">{</span>
<span class="token number">1090</span>              listener<span class="token punctuation">.</span><span class="token function">onAccessibilityEvent</span><span class="token punctuation">(</span>event<span class="token punctuation">,</span> serviceWantsEvent<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">1091</span>              <span class="token keyword">if</span> <span class="token punctuation">(</span>DEBUG<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">1092</span>                  <span class="token class-name">Slog</span><span class="token punctuation">.</span><span class="token function">i</span><span class="token punctuation">(</span>LOG_TAG<span class="token punctuation">,</span> <span class="token string">"Event "</span> <span class="token operator">+</span> event <span class="token operator">+</span> <span class="token string">" sent to "</span> <span class="token operator">+</span> listener<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">1093</span>              <span class="token punctuation">}</span>
<span class="token number">1094</span>          <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RemoteException</span> re<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">1095</span>              <span class="token class-name">Slog</span><span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span>LOG_TAG<span class="token punctuation">,</span> <span class="token string">"Error during sending "</span> <span class="token operator">+</span> event <span class="token operator">+</span> <span class="token string">" to "</span> <span class="token operator">+</span> listener<span class="token punctuation">,</span> re<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">1096</span>          <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
<span class="token number">1097</span>              event<span class="token punctuation">.</span><span class="token function">recycle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">1098</span>          <span class="token punctuation">}</span>
<span class="token number">1099</span>      <span class="token punctuation">}</span>
<span class="line-numbers-rows" aria-hidden="true"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div>
<h2>Accessibility Response</h2>
<p>至于这里AS的<code>onAccessibilityEvent()</code>就看实际需求写了，官网给了一个简单的例子：</p>
<p>这里根据AccessibilityEvent的类型来判断，然后case语句，每一步去做什么。</p>
<br>
<div class="image-package">
<div class="image-container" style="max-height: 439px; max-width: 678px;">
<div class="image-container-fill" style="padding-bottom: 64.75%;"></div>
<div class="image-view" data-height="439" data-width="678"><img class="image-loading" data-image-index="11" data-original-filesize="143729" data-original-format="image/png" data-original-height="439" data-original-width="678" data-original-src="//upload-images.jianshu.io/upload_images/4465577-0ddb924d1b9572c5"></div>
</div>
<div class="image-caption">在这里插入图片描述</div>
</div>
<p>那如果要回到View去操作怎么办呢？比如WeChat的例子，我还要回到View中去模拟点击Open按钮怎么办呢？</p>
<p>其实这里我没有具体去深入研究过，不过我找到两篇博客，有兴趣可以看一看。简略的说来就是Dispatch的逆过程了。</p>
<ul>
<li><a href="https://lizhaoxuan.github.io/2018/01/27/AccessibilityService%E5%88%86%E6%9E%90%E4%B8%8E%E9%98%B2%E5%BE%A1/" target="_blank" rel="nofollow">AccessibilityService分析与防御</a></li>
<li><a href="https://hk.saowen.com/a/b2892ce2dbedb7aa697250eeffc6db21354d71c7a5e9e9c19229e5e26df1f690" target="_blank" rel="nofollow">從源碼角度看AccessibilityService</a></li>
</ul>
</article><div></div><div class="_1kCBjS"><div class="_18vaTa"><div class="_3BUZPB"><div tabindex="-1" class="_2Bo4Th" role="button" aria-label="给文章点赞"><i class="anticon" aria-label="ic-like"><svg xmlns="http://www.w3.org/2000/svg" class="" aria-hidden="true" fill="currentColor" focusable="false" width="1em" height="1em"><use xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="#ic-like" /></svg></i></div><span tabindex="-1" class="_1LOh_5" role="button" aria-label="查看点赞列表">17人点赞<i class="anticon anticon-right" aria-label="icon: right"><svg xmlns="http://www.w3.org/2000/svg" class="" aria-hidden="true" fill="currentColor" viewBox="64 64 896 896" focusable="false" width="1em" height="1em" data-icon="right"><path d="M 765.7 486.8 L 314.9 134.7 A 7.97 7.97 0 0 0 302 141 v 77.3 c 0 4.9 2.3 9.6 6.1 12.6 l 360 281.1 l -360 281.1 c -3.9 3 -6.1 7.7 -6.1 12.6 V 883 c 0 6.7 7.7 10.4 12.9 6.3 l 450.8 -352.1 a 31.96 31.96 0 0 0 0 -50.4 Z" /></svg></i></span></div><div class="_3BUZPB"><div tabindex="-1" class="_2Bo4Th" role="button"><i class="anticon" aria-label="ic-dislike"><svg xmlns="http://www.w3.org/2000/svg" class="" aria-hidden="true" fill="currentColor" focusable="false" width="1em" height="1em"><use xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="#ic-dislike" /></svg></i></div></div></div><div class="_18vaTa"><a class="_3BUZPB _1x1ok9 _1OhGeD" href="/nb/31064747" target="_blank" rel="noopener noreferrer"><i class="anticon" aria-label="ic-notebook"><svg xmlns="http://www.w3.org/2000/svg" class="" aria-hidden="true" fill="currentColor" focusable="false" width="1em" height="1em"><use xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="#ic-notebook" /></svg></i><span>Android9.0源码学习</span></a><div class="_3BUZPB ant-dropdown-trigger"><div class="_2Bo4Th"><i class="anticon" aria-label="ic-others"><svg xmlns="http://www.w3.org/2000/svg" class="" aria-hidden="true" fill="currentColor" focusable="false" width="1em" height="1em"><use xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="#ic-others" /></svg></i></div></div></div></div><div class="_19DgIp" style="margin-top: 24px; margin-bottom: 24px;"></div><div class="_13lIbp"><div class="_191KSt">"您的支持是对我最大的鼓励"</div><button class="_1OyPqC _3Mi9q9 _2WY0RL _1YbC5u" type="button"><span>赞赏支持</span></button><span class="_3zdmIj">还没有人赞赏，支持一下</span></div><div class="d0hShY"><a class="_1OhGeD" href="/u/aced53dd9020" target="_blank" rel="noopener noreferrer"><img class="_27NmgV" alt="  " src="images/android05714.jpg"></a><div class="Uz-vZq"><div class="Cqpr1X"><a title="Dufre" class="HC3FFO _1OhGeD" href="/u/aced53dd9020" target="_blank" rel="noopener noreferrer">Dufre</a><span title="旅行中的程序员&#10;目前正在把csdn和蚂蜂窝的文章整理到简书来。&#10;蚂蜂窝主页：http://..." class="_2WEj6j">旅行中的程序员
目前正在把csdn和蚂蜂窝的文章整理到简书来。
蚂蜂窝主页：http://...</span></div><div class="lJvI3S"><span>总资产14 (约1.34元)</span><span>共写了3.9W字</span><span>获得258个赞</span><span>共84个粉丝</span></div></div><button class="_1OyPqC _3Mi9q9" type="button" data-locale="zh-CN"><span>关注</span></button></div></section>

</div>


</body></html>