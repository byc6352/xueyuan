<HTML><HEAD><TITLE>Delphi通过IE窗口句柄获取网页接口（IWebBrowser2）</TITLE>
<META charset=utf-8>
<META name=viewport content="width=device-width, initial-scale=1.0"><LINK rel=stylesheet href="images/style.css"></HEAD>
<BODY class=stackedit>
<DIV class=stackedit__html>
<DIV class=detailcontennt><SPAN id=Label3>
<P>标签：</P>
<P deep="5">主要用到的是MSAA(Microsoft Active Accessibility) 函数：ObjectFromLResult，该函数在动态链接库 oleacc.dll 中定义。<BR data-filtered="filtered"><BR data-filtered="filtered"><SPAN style="COLOR: #ff0000">uses SHDocVw, MsHtml, ActiveX;<BR data-filtered="filtered"><BR data-filtered="filtered"><STRONG>type</STRONG><BR data-filtered="filtered">&nbsp; TObjectFromLResult = function(LRESULT: lResult; const IID: TIID; WPARAM: wParam; out pObject): HRESULT; stdcall;<BR data-filtered="filtered"><BR data-filtered="filtered"><STRONG>function</STRONG> GetIEFromHWND(WHandle: HWND; var IE: IWebbrowser2): HRESULT;<BR data-filtered="filtered"><STRONG>var</STRONG><BR data-filtered="filtered">&nbsp; hInst: HWND;<BR data-filtered="filtered">&nbsp; lRes: Cardinal;<BR data-filtered="filtered">&nbsp; MSG: Integer;<BR data-filtered="filtered">&nbsp; pDoc: IHTMLDocument2;<BR data-filtered="filtered">&nbsp; ObjectFromLresult: TObjectFromLresult;<BR data-filtered="filtered"><STRONG>begin<BR data-filtered="filtered">&nbsp; </STRONG>Result := S_False;<BR data-filtered="filtered">&nbsp; hInst := LoadLibrary(‘Oleacc.dll‘);<BR data-filtered="filtered">&nbsp; @ObjectFromLresult := GetProcAddress(hInst, ‘ObjectFromLresult‘);<BR data-filtered="filtered">&nbsp; if @ObjectFromLresult &lt;&gt; nil then begin<BR data-filtered="filtered">&nbsp;&nbsp;&nbsp; try<BR data-filtered="filtered">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; MSG := RegisterWindowMessage(‘WM_HTML_GETOBJECT‘);<BR data-filtered="filtered">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; SendMessageTimeOut(WHandle, MSG, 0, 0, SMTO_ABORTIFHUNG, 1000, lRes);<BR data-filtered="filtered">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Result := ObjectFromLresult(lRes, IHTMLDocument2, 0, pDoc);<BR data-filtered="filtered">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if Result = S_OK then<BR data-filtered="filtered">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (pDoc.parentWindow as IServiceprovider).QueryService(IWebbrowserApp, IWebbrowser2, IE);<BR data-filtered="filtered">&nbsp;&nbsp;&nbsp; finally<BR data-filtered="filtered">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; FreeLibrary(hInst);<BR data-filtered="filtered">&nbsp;&nbsp;&nbsp; end;<BR data-filtered="filtered">&nbsp; end;<BR data-filtered="filtered"><STRONG>end;</STRONG><BR data-filtered="filtered"><BR data-filtered="filtered">调用例子，以下代码快速关闭所有打开的IE窗口：<BR data-filtered="filtered"><BR data-filtered="filtered"><STRONG>procedure</STRONG> TForm1.Button1Click(Sender: TObject);<BR data-filtered="filtered"><STRONG>var</STRONG><BR data-filtered="filtered">&nbsp;&nbsp;&nbsp; hCurWindow, hMainWnd, hTabWnd, hCldWnd:HWnd; <SPAN style="COLOR: #000080">//窗口句柄<BR data-filtered="filtered">&nbsp;&nbsp;&nbsp; WinClsName:array[0..255] of char;<BR data-filtered="filtered">&nbsp;&nbsp;&nbsp; IE1: IWebbrowser2;<BR data-filtered="filtered"><STRONG>begin</STRONG><BR data-filtered="filtered">&nbsp;&nbsp;&nbsp; hCurWindow := GetWindow(Handle,GW_HWNDFirst);&nbsp; <SPAN style="COLOR: #000080">//获取第一个窗口的句柄<BR data-filtered="filtered">&nbsp;&nbsp;&nbsp; while hCurWindow&lt;&gt;0 do<BR data-filtered="filtered">&nbsp;&nbsp;&nbsp; begin<BR data-filtered="filtered">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; GetClassName(hCurWindow, @WinClsName, 255);<BR data-filtered="filtered">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if String(WinClsName) = ‘IEFrame‘ then<BR data-filtered="filtered">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; begin<BR data-filtered="filtered">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; hMainWnd := hCurWindow;<BR data-filtered="filtered">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; hCldWnd := hCurWindow;<BR data-filtered="filtered">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; hTabWnd := 0;<BR data-filtered="filtered">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; repeat <SPAN style="COLOR: #000080">//循环查找所有选项卡<BR data-filtered="filtered">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; hTabWnd := FindWindowEx(hMainWnd, hTabWnd, ‘Frame Tab‘, nil);<BR data-filtered="filtered">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if hTabWnd &lt;&gt; 0 then hCldWnd := FindWindowEx(hTabWnd, 0, ‘TabWindowClass‘, nil);<BR data-filtered="filtered">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if hCldWnd &lt;&gt; 0 then hCldWnd := FindWindowEx(hCldWnd, 0, ‘Shell DocObject View‘, nil);<BR data-filtered="filtered">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if hCldWnd &lt;&gt; 0 then hCldWnd := FindWindowEx(hCldWnd, 0, ‘Internet Explorer_Server‘, nil);<BR data-filtered="filtered">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if hCldWnd &lt;&gt; 0 then if GetIEFromHWnd(hCldWnd, IE1) = S_OK then <SPAN style="COLOR: #000080">//获取IWebBrowser2<BR data-filtered="filtered">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; begin<BR data-filtered="filtered">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; IE1.Quit; <SPAN style="COLOR: #000080">//关闭IE，也可以执行其他操作，呵呵<BR data-filtered="filtered">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; end;<BR data-filtered="filtered">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; until hTabWnd = 0;<BR data-filtered="filtered">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; end;<BR data-filtered="filtered">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; hCurWindow:=GetWindow(hCurWindow,GW_HWNDNEXT); <SPAN style="COLOR: #000080">//获取下一个窗口的句柄<BR data-filtered="filtered">&nbsp;&nbsp;&nbsp; end;<BR data-filtered="filtered"><STRONG>end; <BR data-filtered="filtered"></STRONG></SPAN></SPAN></SPAN></SPAN></SPAN></SPAN></SPAN></P>
<P><A title=Delphi通过IE窗口句柄获取网页接口（IWebBrowser2）,mamicode.com style="COLOR: #ffffff" href="http://www.mamicode.com/info-detail-974835.html" target=_blank>Delphi通过IE窗口句柄获取网页接口（IWebBrowser2）</A></P>
<P>标签：</P>
<P>原文地址：http://www.cnblogs.com/stroll/p/4716298.html</P></SPAN></DIV></DIV></BODY></HTML>